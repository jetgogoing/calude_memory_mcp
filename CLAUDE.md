### 开发指南

所有测试模块必须放在tests文件夹中，不允许散落在根目录中


- 始终使用中文与我对话
请ONLY修改[具体文件/函数/部分]，不要触碰其他任何代码。严格按照要求执行，不要添加、删除或修改任何未明确要求的部分。
在执行任何修改前，先告诉我你计划修改哪些具体文件和行数。如果需要修改计划范围外的内容，必须先征得我的同意。
采用最小修改原则：只改变实现目标所必需的最少代码。保持现有代码结构、风格和模式不变。
你需要诚实面对失败，而不是使用各种默认值或者模拟数据为了通过模块测试。

### 代码开发原则
- **始终使用中文与我沟通**
- **只修改明确要求的文件/函数**
- **在执行任何修改前，先告诉我具体计划**
- **采用最小修改原则**
- **诚实面对失败，不使用模拟数据蒙混过关**


# PROJECT MEMORY

## Critical Decisions Log

### 2025-01-06 - Claude记忆管理MCP服务架构决策

**决策内容：** 基于OpenAI O3-mini深度审阅，确定Claude记忆管理MCP服务的核心架构决策

#### 架构决策
1. **独立MCP项目**：完全移除ZEN-MCP-SERVER集成，设计为独立运行的MCP服务
2. **四层架构**：数据采集层 → 语义处理层 → 存储检索层 → 智能注入层 + 独立服务管理层
3. **多模型协作**：使用Gemini、OpenRouter、SiliconFlow多API策略，确保稳定性和成本控制
4. **双重记忆机制**：Quick-MU(实时) + Global-MU(深度整合)提供不同粒度的记忆能力

#### 技术栈选择
- 数据存储：SQLite/PostgreSQL + Qdrant向量数据库
- 语义模型：DeepSeek(轻量)、Gemini 2.5 Pro(重型)、专用Embedding模型
- 框架：FastAPI + 异步处理 + Docker容器化部署
- 监控：自建监控系统 + 实时告警机制

#### 关键性能指标
- 语义检索延迟 ≤ 150ms
- 端到端处理延迟 ≤ 300ms  
- 记忆检索准确率 ≥ 90%
- 服务可用性 ≥ 99.5%

#### 风险缓解策略
- Claude CLI Hook失效：多种捕获方案备选
- 多模型API不稳定：模型池 + 自动降级
- Token预算超限：动态压缩 + 智能截断
- 数据一致性：事务管理 + 自动备份

## Error Patterns & Solutions

## Status Updates

### 2025-07-06 - 项目启动
- 完成OpenAI O3-mini架构审阅
- 确定独立MCP服务技术方案
- 移除ZEN集成相关设计
- 准备开始核心模块开发
### 2025-0-07 - 核心架构实现完成
- ✅ 完成四层架构的完整实现
- ✅ 数据采集层：ConversationCollector (多方式对话捕获)
- ✅ 语义处理层：SemanticCompressor (多模型协作压缩)
- ✅ 存储检索层：SemanticRetriever (向量数据库+混合检索)
- ✅ 智能注入层：ContextInjector (动态上下文构建)
- ✅ 服务管理层：ServiceManager (生命周期管理)
- ✅ MCP服务接口：完整的MCP协议实现
- ✅ 目录结构优化：移除嵌套结构，简化为根目录布局

### 2025-07-07 - 项目结构调整
- **决策内容：** 目录结构重组，移除claude-memory-mcp嵌套子目录
- **实施过程：** 移动所有文件到根目录，验证导入路径，修复包初始化
- **结果：** 项目结构更清晰，所有模块引用正确，可正常运行

#### Session 1 (2025-07-07)
- **主要任务**: 使用OpenAI O3制定Claude记忆管理MCP服务完整部署计划
- **完成内容**: 已完成部署计划设计，包含5个阶段：环境准备、配置管理、CLI集成、功能验证、运维监控
- **关键发现**: 制定了详细的实施脚本、验证检查点、监控方案和维护计划，涵盖从环境搭建到生产运维的完整流程
- **下次计划**: 开始实施第一阶段的环境准备工作，创建Python虚拟环境并安装依赖

#### Session 2 (2025-07-07)
- **主要任务**: 解决MCP服务stdio通信问题，实现完整生产部署
- **核心问题**: MCP服务在Claude CLI中显示"failed"状态，根本原因是structlog日志输出到stdout干扰JSON-RPC通信协议
- **解决方案**: 创建`fixed_production_mcp.py`，实现stderr重定向、日志文件输出、完整MCP协议支持
- **完成成果**:
  - ✅ Systemd服务成功运行 (`claude-memory-mcp.service`)
  - ✅ Claude CLI配置更新 (`~/.claude.json`)
  - ✅ stdio通信协议修复 (JSON-RPC 2.0完整实现)
  - ✅ 生产级日志系统 (文件轮转、错误处理)
  - ✅ 健康检查和监控体系
- **技术关键点**: 
  - 识别并解决structlog输出干扰问题
  - 实现完整的MCP协议方法 (initialize, tools/list, tools/call等)
  - 配置systemd自动重启和故障恢复
- **系统状态**: 完全就绪，可在Claude CLI中使用`/mcp claude-memory`命令调用所有记忆管理功能

  ✅ Claude CLI MCP配置完成
  - MCP服务器配置文件已创建并正确配置
  - Claude CLI自动发现和加载MCP服务
  - Python路径和工作目录配置正确

  ✅ 服务连接验证通过
  - Qdrant向量数据库服务正常运行
  - SSL连接问题已修复，客户端正常连接
  - 向量集合自动创建成功

  ✅ 完整功能验证通过
  - MCP服务器初始化和清理流程正常
  - 所有依赖和配置文件验证通过
  - 部署验证脚本8项检查全部通过

  ✅ 管理工具链完整
  - 5个管理脚本全部就绪且可执行
  - 完整的启动、停止、配置、测试工具
  - 详细的集成指南和故障排除

  🚀 系统状态：完全就绪

  Claude Memory MCP服务已成功集成到Claude CLI，所有组件正常运行，可以开始提供智能记忆管理功能！


#### Session 3: ### 2025-07-07 - MCP服务器stdio通信修复方案

**问题诊断：** MCP服务器在Claude CLI中显示failed状态，虽然进程正常运行

**根本原因：** 
1. structlog日志输出到stdout，干扰了MCP的stdio通信协议
2. Qdrant警告信息输出到stderr，被Claude CLI识别为错误

**解决方案：**
1. 创建fixed_production_mcp.py，重定向所有日志到文件
2. 使用StderrToLogger类捕获stderr输出
3. 配置structlog只写入日志文件，不输出到控制台
4. 更新Claude CLI配置使用修复版本

**验证结果：** 服务正常初始化，日志记录到文件，不干扰stdio通信
