# Claude Memory MCP 全局服务容器
FROM python:3.11-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.global.txt /app/requirements.txt

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制源代码
COPY src/ /app/src/
COPY config/ /app/config/
COPY scripts/ /app/scripts/

# 复制全局MCP服务器
COPY src/global_mcp/global_mcp_server.py /app/global_mcp_server.py
COPY src/global_mcp/global_memory_manager.py /app/global_memory_manager.py

# 复制健康检查脚本
COPY scripts/healthcheck.py /app/healthcheck.py

# 创建数据目录
RUN mkdir -p /app/data /app/logs /app/config

# 设置权限
RUN chmod +x /app/global_mcp_server.py /app/healthcheck.py /app/scripts/init_global_database.py

# 设置环境变量
ENV PYTHONPATH=/app/src
ENV PYTHONUNBUFFERED=1
ENV DATA_DIR=/app/data
ENV LOG_LEVEL=INFO

# 暴露MCP端口
EXPOSE 6334

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python /app/healthcheck.py

# 启动全局MCP服务器
CMD ["python", "/app/global_mcp_server.py"]