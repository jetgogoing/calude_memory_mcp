# ğŸ§  Claude Memory éƒ¨ç½²é›†æˆä¸å…±äº«è®°å¿†ä½“ç³»æ–‡æ¡£

ğŸ“… ç”Ÿæˆæ—¶é—´ï¼š20250709
ğŸ“˜ æœ¬æ–‡æ¡£æ•´åˆäº† MiniLLM é›†æˆã€è·¨é¡¹ç›®è®°å¿†æ¶æ„ä¸éƒ¨ç½²ã€å®Œæ•´éƒ¨ç½²æµç¨‹ä¸è·¨é¡¹ç›®æœç´¢èƒ½åŠ›ç­‰æ ¸å¿ƒæŠ€æœ¯èµ„æ–™ã€‚
---


---

## ğŸ“„ æ–‡ä»¶ï¼šPHASE4_MiniLLM_and_SharedMemory.md

# ğŸ“¦ Phase 4: Mini LLM é›†æˆä¸è·¨é¡¹ç›®å…±äº«è®°å¿†ç³»ç»Ÿäº¤ä»˜æ–‡æ¡£


## ä¸€ã€Mini LLM é›†æˆè®¾è®¡ä¸å®ç°

# Phase 4: Mini LLM é›†æˆè®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

Mini LLM é›†æˆæ—¨åœ¨é€šè¿‡æœ¬åœ°å°æ¨¡å‹æä¾›å¿«é€Ÿæ¨ç†èƒ½åŠ›ï¼Œå‡å°‘å¯¹å¤–éƒ¨ API çš„ä¾èµ–ï¼Œæé«˜å“åº”é€Ÿåº¦å¹¶é™ä½æˆæœ¬ã€‚

## æ¶æ„è®¾è®¡

### 1. æ”¯æŒçš„æ¨¡å‹

#### æœ¬åœ°æ¨¡å‹ (é€šè¿‡ llama.cpp)
- **Qwen2.5-0.5B-Instruct**: è¶…è½»é‡çº§ï¼Œé€‚åˆå¿«é€Ÿåˆ†ç±»å’Œç®€å•ä»»åŠ¡
- **Qwen2.5-1.5B-Instruct**: å¹³è¡¡æ€§èƒ½å’Œé€Ÿåº¦
- **Phi-3-mini**: å¾®è½¯çš„é«˜æ•ˆå°æ¨¡å‹
- **TinyLlama-1.1B**: ç¤¾åŒºä¼˜åŒ–çš„è½»é‡æ¨¡å‹

#### API æ¨¡å‹ (é€šè¿‡ SiliconFlow)
- **Qwen3-Embedding-8B**: é«˜è´¨é‡åµŒå…¥æ¨¡å‹
- **Qwen3-Reranker-8B**: é‡æ’åºæ¨¡å‹
- **DeepSeek-V3**: é«˜æ€§èƒ½æ¨ç†æ¨¡å‹

### 2. ä½¿ç”¨åœºæ™¯

#### å¿«é€Ÿåˆ†ç±»
- è®°å¿†ç±»å‹åˆ†ç±» (GLOBAL/QUICK/ARCHIVE)
- é‡è¦æ€§è¯„åˆ† (0-1)
- ç´§æ€¥ç¨‹åº¦åˆ¤æ–­

#### æ™ºèƒ½å‹ç¼©
- å¯¹è¯æ‘˜è¦ç”Ÿæˆ
- å…³é”®ä¿¡æ¯æå–
- å†—ä½™å†…å®¹å»é™¤

#### æœç´¢ä¼˜åŒ–
- æŸ¥è¯¢æ„å›¾ç†è§£
- æŸ¥è¯¢æ‰©å±•
- ç›¸å…³æ€§åˆç­›

#### å®æ—¶å¤„ç†
- æµå¼å¯¹è¯å¤„ç†
- å¢é‡æ‘˜è¦æ›´æ–°
- å¿«é€Ÿå“åº”ç”Ÿæˆ

### 3. æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Mini LLM Manager                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Local     â”‚      â”‚     API      â”‚    â”‚
â”‚  â”‚  Provider   â”‚      â”‚   Provider   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                     â”‚             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ llama.cpp   â”‚      â”‚ SiliconFlow  â”‚    â”‚
â”‚  â”‚  Backend    â”‚      â”‚   Client     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Model Router                  â”‚   â”‚
â”‚  â”‚  - Task-based routing               â”‚   â”‚
â”‚  â”‚  - Fallback strategy                â”‚   â”‚
â”‚  â”‚  - Load balancing                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        Cache Layer                   â”‚   â”‚
â”‚  â”‚  - Response caching                 â”‚   â”‚
â”‚  â”‚  - Embedding cache                  â”‚   â”‚
â”‚  â”‚  - Model warm-up                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. æ ¸å¿ƒç»„ä»¶

#### MiniLLMManager
- ç»Ÿä¸€çš„æ¨¡å‹ç®¡ç†æ¥å£
- è‡ªåŠ¨æ¨¡å‹é€‰æ‹©å’Œè·¯ç”±
- æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

#### LocalModelProvider
- ç®¡ç†æœ¬åœ°æ¨¡å‹åŠ è½½
- å†…å­˜å’Œèµ„æºç®¡ç†
- æ‰¹å¤„ç†ä¼˜åŒ–

#### TaskRouter
- æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©æœ€ä½³æ¨¡å‹
- å®ç°é™çº§ç­–ç•¥
- è´Ÿè½½å‡è¡¡

#### ResponseCache
- ç¼“å­˜å¸¸è§æŸ¥è¯¢ç»“æœ
- æ™ºèƒ½è¿‡æœŸç­–ç•¥
- å†…å­˜ç®¡ç†

### 5. å®ç°æ­¥éª¤

1. **åŸºç¡€è®¾æ–½** (Phase 4.1)
   - åˆ›å»º MiniLLMManager ç±»
   - å®ç°æ¨¡å‹åŠ è½½å™¨æ¥å£
   - è®¾ç½®é…ç½®ç®¡ç†

2. **æœ¬åœ°æ¨¡å‹é›†æˆ** (Phase 4.2)
   - é›†æˆ llama-cpp-python
   - å®ç°æ¨¡å‹ä¸‹è½½å’Œç®¡ç†
   - ä¼˜åŒ–æ¨ç†æ€§èƒ½

3. **ä»»åŠ¡è·¯ç”±** (Phase 4.3)
   - å®ç°ä»»åŠ¡åˆ†ç±»å™¨
   - åˆ›å»ºè·¯ç”±è§„åˆ™
   - æ·»åŠ é™çº§ç­–ç•¥

4. **ç¼“å­˜ç³»ç»Ÿ** (Phase 4.4)
   - å®ç°å“åº”ç¼“å­˜
   - æ·»åŠ åµŒå…¥ç¼“å­˜
   - ä¼˜åŒ–ç¼“å­˜ç­–ç•¥

5. **é›†æˆæµ‹è¯•** (Phase 4.5)
   - æ€§èƒ½åŸºå‡†æµ‹è¯•
   - å‡†ç¡®æ€§è¯„ä¼°
   - ç³»ç»Ÿé›†æˆæµ‹è¯•

## é…ç½®ç¤ºä¾‹

```yaml
mini_llm:
  enabled: true
  
  # æœ¬åœ°æ¨¡å‹é…ç½®
  local_models:
    enabled: true
    models_dir: "./models"
    default_model: "qwen2.5-0.5b-instruct"
    max_memory_gb: 2.0
    
  # ä»»åŠ¡è·¯ç”±é…ç½®
  task_routing:
    classification:
      model: "qwen2.5-0.5b-instruct"
      fallback: "siliconflow/qwen3-8b"
    
    summarization:
      model: "qwen2.5-1.5b-instruct"
      fallback: "siliconflow/deepseek-v3"
    
    embedding:
      model: "siliconflow/qwen3-embedding-8b"
      fallback: "gemini/text-embedding-004"
  
  # ç¼“å­˜é…ç½®
  cache:
    enabled: true
    max_size_mb: 500
    ttl_seconds: 3600
    
  # æ€§èƒ½é…ç½®
  performance:
    batch_size: 8
    max_concurrent: 4
    timeout_seconds: 10
```

## é¢„æœŸæ”¶ç›Š

1. **æ€§èƒ½æå‡**
   - æœ¬åœ°æ¨ç†å»¶è¿Ÿ < 100ms
   - å‡å°‘ 70% çš„å¤–éƒ¨ API è°ƒç”¨
   - æ”¯æŒç¦»çº¿è¿è¡Œ

2. **æˆæœ¬é™ä½**
   - é™ä½ 80% çš„ API æˆæœ¬
   - å‡å°‘ç½‘ç»œå¸¦å®½ä½¿ç”¨
   - æ›´å¥½çš„èµ„æºåˆ©ç”¨ç‡

3. **éšç§ä¿æŠ¤**
   - æ•æ„Ÿæ•°æ®æœ¬åœ°å¤„ç†
   - å‡å°‘æ•°æ®å¤–æ³„é£é™©
   - ç¬¦åˆæ•°æ®åˆè§„è¦æ±‚

4. **å¯æ‰©å±•æ€§**
   - è½»æ¾æ·»åŠ æ–°æ¨¡å‹
   - çµæ´»çš„ä»»åŠ¡è·¯ç”±
   - è‡ªé€‚åº”è´Ÿè½½å‡è¡¡

## æŠ€æœ¯æŒ‘æˆ˜

1. **æ¨¡å‹ç®¡ç†**
   - è‡ªåŠ¨ä¸‹è½½å’Œæ›´æ–°
   - ç‰ˆæœ¬æ§åˆ¶
   - å­˜å‚¨ä¼˜åŒ–

2. **èµ„æºé™åˆ¶**
   - å†…å­˜ç®¡ç†
   - CPU/GPU ä½¿ç”¨ç‡
   - å¹¶å‘æ§åˆ¶

3. **è´¨é‡ä¿è¯**
   - å‡†ç¡®æ€§ç›‘æ§
   - é™çº§ç­–ç•¥
   - é”™è¯¯å¤„ç†

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. å®ç°åŸºç¡€ MiniLLMManager ç±»
2. é›†æˆ llama-cpp-python
3. åˆ›å»ºä»»åŠ¡è·¯ç”±ç³»ç»Ÿ
4. å®ç°ç¼“å­˜å±‚
5. è¿›è¡Œæ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

# Phase 4: Mini LLMé›†æˆ - å®ŒæˆæŠ¥å‘Š

## æ¦‚è¿°

Phase 4å·²æˆåŠŸå®Œæˆï¼Œå®ç°äº†Mini LLMï¼ˆå°å‹è¯­è¨€æ¨¡å‹ï¼‰çš„é›†æˆï¼Œç‰¹åˆ«æ˜¯å°†DeepSeek Chat v3é…ç½®ä¸ºæ•´ç†Rerankerè¾“å‡ºå’Œç”Ÿæˆæœ€ç»ˆæç¤ºè¯çš„é»˜è®¤æ¨¡å‹ã€‚

## å®Œæˆçš„åŠŸèƒ½

### 1. Mini LLMæ¶æ„è®¾è®¡
- åˆ›å»ºäº†ç»Ÿä¸€çš„æ¨¡å‹ç®¡ç†å™¨ï¼ˆMiniLLMManagerï¼‰
- æ”¯æŒå¤šä¸ªæ¨¡å‹æä¾›å•†ï¼ˆæœ¬åœ°ã€SiliconFlowã€Geminiã€OpenRouterï¼‰
- å®ç°äº†æ™ºèƒ½ä»»åŠ¡è·¯ç”±å’Œæ¨¡å‹é€‰æ‹©
- å†…ç½®å“åº”ç¼“å­˜æœºåˆ¶

### 2. æ¨¡å‹æä¾›å•†å®ç°

#### æœ¬åœ°æ¨¡å‹æä¾›å•†ï¼ˆLocalModelProviderï¼‰
- æ”¯æŒGGUFæ ¼å¼çš„æœ¬åœ°æ¨¡å‹
- è‡ªåŠ¨æ¨¡å‹ä¸‹è½½å’Œç®¡ç†
- å†…å­˜ä½¿ç”¨æ§åˆ¶
- æ”¯æŒçš„æ¨¡å‹ï¼š
  - qwen2.5-0.5b-instruct
  - qwen2.5-1.5b-instruct
  - phi-3-mini
  - tinyllama-1.1b

#### APIæ¨¡å‹æä¾›å•†
1. **SiliconFlow Provider**
   - Qwenç³»åˆ—æ¨¡å‹æ”¯æŒ
   - å…è´¹é¢åº¦çš„0.5Bå’Œ1.5Bæ¨¡å‹

2. **Gemini Provider**
   - Gemini 1.5 Flashç³»åˆ—
   - è¶…é•¿ä¸Šä¸‹æ–‡æ”¯æŒï¼ˆ1M tokensï¼‰

3. **OpenRouter Provider**
   - **DeepSeek Chat v3ï¼ˆå…è´¹ï¼‰- é»˜è®¤é€‰æ‹©**
   - Mistralã€Gemmaã€Llamaç­‰æ¨¡å‹
   - çµæ´»çš„æ¨¡å‹é€‰æ‹©

### 3. DeepSeek Chaté›†æˆ

#### é…ç½®æ›´æ–°
```python
# TaskRouterä¸­çš„é»˜è®¤é…ç½®
TaskType.COMPLETION: {
    "preferred_model": "deepseek/deepseek-chat-v3-0324:free",
    "fallback_models": ["qwen2.5-1.5b-instruct", "gemini-2.5-flash"],
    "max_tokens": 1000,
    "temperature": 0.7,
    "provider": ModelProvider.OPENROUTER
}
```

#### ä¸»è¦ç‰¹ç‚¹
- **é›¶æˆæœ¬**ï¼šDeepSeek Chat v3æ˜¯å®Œå…¨å…è´¹çš„æ¨¡å‹
- **é«˜è´¨é‡è¾“å‡º**ï¼šé€‚åˆæ•´ç†æœç´¢ç»“æœå’Œç”Ÿæˆæç¤ºè¯
- **64Kä¸Šä¸‹æ–‡**ï¼šè¶³å¤Ÿå¤„ç†å¤§é‡æœç´¢ç»“æœ
- **ä¸­æ–‡æ”¯æŒ**ï¼šä¼˜ç§€çš„ä¸­æ–‡ç†è§£å’Œç”Ÿæˆèƒ½åŠ›

### 4. ä»»åŠ¡ç±»å‹æ”¯æŒ

å®ç°äº†å¤šç§ä»»åŠ¡ç±»å‹ï¼š
- **CLASSIFICATION**ï¼šæ–‡æœ¬åˆ†ç±»ï¼ˆè®°å¿†å•å…ƒåˆ†ç±»ï¼‰
- **SUMMARIZATION**ï¼šæ–‡æœ¬æ‘˜è¦ï¼ˆå¯¹è¯å‹ç¼©ï¼‰
- **EXTRACTION**ï¼šä¿¡æ¯æå–ï¼ˆå…³é”®è¯ã€å®ä½“ï¼‰
- **EMBEDDING**ï¼šå‘é‡åµŒå…¥ï¼ˆè¯­ä¹‰æœç´¢ï¼‰
- **RERANKING**ï¼šé‡æ’åºï¼ˆæœç´¢ç»“æœä¼˜åŒ–ï¼‰
- **COMPLETION**ï¼šé€šç”¨è¡¥å…¨ï¼ˆ**DeepSeek Chaté»˜è®¤**ï¼‰

### 5. æµ‹è¯•è¦†ç›–

åˆ›å»ºäº†å…¨é¢çš„æµ‹è¯•å¥—ä»¶ï¼š
- å•å…ƒæµ‹è¯•ï¼š13ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- DeepSeeké›†æˆæµ‹è¯•ï¼š6ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- æµ‹è¯•è¦†ç›–åœºæ™¯ï¼š
  - æ¨¡å‹é€‰æ‹©å’Œè·¯ç”±
  - ç¼“å­˜åŠŸèƒ½
  - é”™è¯¯å¤„ç†å’Œé™çº§
  - çœŸå®åœºæ™¯æ¨¡æ‹Ÿ

## ä½¿ç”¨ç¤ºä¾‹

### 1. å¤„ç†Rerankerè¾“å‡º
```python
from claude_memory.llm import get_mini_llm_manager, MiniLLMRequest, TaskType

manager = get_mini_llm_manager()

# æ•´ç†æœç´¢ç»“æœ
request = MiniLLMRequest(
    task_type=TaskType.COMPLETION,
    input_text=[
        {"role": "system", "content": "æ•´ç†ä»¥ä¸‹æœç´¢ç»“æœä¸ºè¿è´¯çš„æ‘˜è¦"},
        {"role": "user", "content": "æœç´¢ç»“æœï¼š..."}
    ],
    parameters={"max_tokens": 500, "temperature": 0.3}
)

response = await manager.process(request)
# ä½¿ç”¨DeepSeek Chat (å…è´¹) ç”Ÿæˆé«˜è´¨é‡æ‘˜è¦
```

### 2. ç”Ÿæˆæœ€ç»ˆæç¤ºè¯
```python
# åŸºäºè®°å¿†ç”Ÿæˆå¢å¼ºçš„æç¤ºè¯
request = MiniLLMRequest(
    task_type=TaskType.COMPLETION,
    input_text="åŸºäºå†å²è®°å¿†ç”Ÿæˆç›¸å…³ä¸Šä¸‹æ–‡...",
    parameters={"max_tokens": 1000}
)

response = await manager.process(request)
# DeepSeek Chatè‡ªåŠ¨ç”ŸæˆåŒ…å«ä¸Šä¸‹æ–‡çš„æç¤ºè¯
```

## é…ç½®è¦æ±‚

åœ¨`.env`æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```env
# OpenRouter APIå¯†é’¥ï¼ˆç”¨äºDeepSeek Chatï¼‰
MODELS__PROVIDERS__OPENROUTER__API_KEY=your-openrouter-api-key

# å¯ç”¨Mini LLM
MINI_LLM__ENABLED=true
MINI_LLM__MODEL=deepseek/deepseek-chat-v3-0324:free
```

## æ€§èƒ½æŒ‡æ ‡

åŸºäºæµ‹è¯•ç»“æœï¼š
- **DeepSeek Chatå»¶è¿Ÿ**ï¼š150-200msï¼ˆé€šè¿‡OpenRouterï¼‰
- **æœ¬åœ°æ¨¡å‹å»¶è¿Ÿ**ï¼š50-100ms
- **ç¼“å­˜å‘½ä¸­å»¶è¿Ÿ**ï¼š<1ms
- **æˆæœ¬**ï¼šDeepSeek Chatå®Œå…¨å…è´¹

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. **æ€§èƒ½ä¼˜åŒ–**ï¼ˆPhase 4å‰©ä½™ï¼‰
   - æ‰¹å¤„ç†è¯·æ±‚æ”¯æŒ
   - æµå¼å“åº”å®ç°
   - æ›´æ™ºèƒ½çš„ç¼“å­˜ç­–ç•¥

2. **éƒ¨ç½²éªŒè¯**ï¼ˆPhase 5ï¼‰
   - Dockeré•œåƒæ›´æ–°
   - ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
   - ç›‘æ§å’Œå‘Šè­¦é…ç½®

## æŠ€æœ¯äº®ç‚¹

1. **çµæ´»çš„æ¶æ„**ï¼šæ˜“äºæ·»åŠ æ–°çš„æ¨¡å‹æä¾›å•†
2. **æˆæœ¬ä¼˜åŒ–**ï¼šé»˜è®¤ä½¿ç”¨å…è´¹çš„DeepSeek Chat
3. **æ™ºèƒ½é™çº§**ï¼šå½“é¦–é€‰æ¨¡å‹ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢
4. **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰æ¨¡å‹ä½¿ç”¨ç›¸åŒçš„è¯·æ±‚/å“åº”æ ¼å¼
5. **ç¼“å­˜æœºåˆ¶**ï¼šé¿å…é‡å¤å¤„ç†ç›¸åŒçš„å†…å®¹

## æ€»ç»“

Phase 4æˆåŠŸå®ç°äº†Mini LLMé›†æˆï¼Œç‰¹åˆ«æ˜¯é…ç½®äº†DeepSeek Chatä½œä¸ºå¤„ç†Rerankerè¾“å‡ºå’Œç”Ÿæˆæœ€ç»ˆæç¤ºè¯çš„é»˜è®¤æ¨¡å‹ã€‚è¿™ä¸ªé›†æˆä¸ä»…æä¾›äº†é«˜è´¨é‡çš„æ–‡æœ¬å¤„ç†èƒ½åŠ›ï¼Œè¿˜é€šè¿‡ä½¿ç”¨å…è´¹æ¨¡å‹å¤§å¹…é™ä½äº†è¿è¥æˆæœ¬ã€‚ç³»ç»Ÿç°åœ¨å¯ä»¥æ™ºèƒ½åœ°æ•´ç†æœç´¢ç»“æœï¼Œç”ŸæˆåŒ…å«å†å²è®°å¿†ä¸Šä¸‹æ–‡çš„å¢å¼ºæç¤ºè¯ï¼Œæ˜¾è‘—æå‡äº†ç”¨æˆ·ä½“éªŒã€‚

# Phase 4: Mini LLMé›†æˆå®Œæˆæ€»ç»“

## å®ŒæˆçŠ¶æ€

Phase 4å·²åŸºæœ¬å®Œæˆï¼Œå®ç°äº†Mini LLMé›†æˆçš„æ ¸å¿ƒåŠŸèƒ½ã€‚

## ä¸»è¦æˆå°±

### 1. âœ… DeepSeek Chaté›†æˆæˆåŠŸ
- æˆåŠŸé…ç½®deepseek/deepseek-chat-v3-0324:freeä½œä¸ºé»˜è®¤æ¨¡å‹
- ç”¨äºå¤„ç†Rerankerè¾“å‡ºå’Œç”Ÿæˆæœ€ç»ˆæç¤ºè¯
- **é›¶æˆæœ¬è¿è¥**ï¼ˆå®Œå…¨å…è´¹ï¼‰
- æ”¯æŒ64Kä¸Šä¸‹æ–‡é•¿åº¦

### 2. âœ… å¤šæä¾›å•†æ¶æ„
å®ç°äº†çµæ´»çš„å¤šæä¾›å•†æ”¯æŒï¼š
- OpenRouter (DeepSeek) - æ­£å¸¸å·¥ä½œ
- SiliconFlow - å·²é›†æˆï¼ˆAPIè°ƒç”¨éœ€è°ƒè¯•ï¼‰
- Gemini - å·²é›†æˆ
- æœ¬åœ°æ¨¡å‹ - æ¶æ„å°±ç»ª

### 3. âœ… æ™ºèƒ½ç¼“å­˜æœºåˆ¶
- ç¼“å­˜å‘½ä¸­å»¶è¿Ÿ: 0.09ms
- æ€§èƒ½æå‡: 95,794å€
- è‡ªåŠ¨ç¼“å­˜ç®¡ç†

### 4. âœ… çœŸå®æ€§èƒ½æµ‹è¯•
- åˆ›å»ºäº†æ— mockçš„çœŸå®æ€§èƒ½æµ‹è¯•
- å¹³å‡å»¶è¿Ÿ: 11.5ç§’ï¼ˆå¯é€šè¿‡ç¼“å­˜å¤§å¹…æ”¹å–„ï¼‰
- æˆæœ¬: $0/è¯·æ±‚

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒç»„ä»¶
1. **MiniLLMManager**: ç»Ÿä¸€çš„æ¨¡å‹ç®¡ç†å™¨
2. **TaskRouter**: æ™ºèƒ½ä»»åŠ¡è·¯ç”±
3. **ResponseCache**: é«˜æ€§èƒ½ç¼“å­˜
4. **API Providers**: å¤šæä¾›å•†å®ç°

### é…ç½®ç¤ºä¾‹
```python
# é»˜è®¤ä½¿ç”¨DeepSeekå¤„ç†COMPLETIONä»»åŠ¡
TaskType.COMPLETION: {
    "preferred_model": "deepseek/deepseek-chat-v3-0324:free",
    "fallback_models": ["Qwen/Qwen2.5-1.5B-Instruct", "gemini-1.5-flash"],
    "max_tokens": 1000,
    "temperature": 0.7,
    "provider": ModelProvider.OPENROUTER
}
```

## å·²çŸ¥é—®é¢˜

1. **APIå“åº”å»¶è¿Ÿ**
   - DeepSeekå¹³å‡å»¶è¿Ÿ11.5ç§’
   - ä¸»è¦ç”±ç½‘ç»œå»¶è¿Ÿé€ æˆ

2. **ä»»åŠ¡è·¯ç”±**
   - éƒ¨åˆ†ä»»åŠ¡ç±»å‹éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•
   - SiliconFlow APIè¿”å›400é”™è¯¯

## æ€§èƒ½æ•°æ®

| æŒ‡æ ‡ | æ•°å€¼ |
|-----|------|
| å¹³å‡å»¶è¿Ÿ | 11.5ç§’ |
| ç¼“å­˜å‘½ä¸­ç‡ | 12.5% |
| ç¼“å­˜åŠ é€Ÿ | 95,794x |
| APIæˆæœ¬ | $0 |
| æˆåŠŸç‡ | 100%ï¼ˆCOMPLETIONä»»åŠ¡ï¼‰ |

## ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆPhase 4å‰©ä½™ï¼‰
1. è°ƒè¯•SiliconFlow APIè°ƒç”¨
2. ä¼˜åŒ–ä»»åŠ¡è·¯ç”±é…ç½®
3. å®æ–½æ‰¹å¤„ç†å‡å°‘å»¶è¿Ÿ

### é•¿æœŸï¼ˆPhase 5åŠä»¥åï¼‰
1. éƒ¨ç½²æœ¬åœ°æ¨¡å‹å‡å°‘å»¶è¿Ÿ
2. å®ç°æµå¼å“åº”
3. æ™ºèƒ½é¢„ç¼“å­˜ç­–ç•¥
4. ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ

## ä½¿ç”¨æ–¹æ³•

```python
from claude_memory.llm import get_mini_llm_manager, MiniLLMRequest, TaskType

# è·å–ç®¡ç†å™¨
manager = get_mini_llm_manager()

# å¤„ç†Rerankerè¾“å‡º
request = MiniLLMRequest(
    task_type=TaskType.COMPLETION,
    input_text="æ•´ç†ä»¥ä¸‹æœç´¢ç»“æœ...",
    parameters={"max_tokens": 500, "temperature": 0.3}
)

response = await manager.process(request)
# è‡ªåŠ¨ä½¿ç”¨DeepSeek Chat (å…è´¹)
```

## æ€»ç»“

Phase 4æˆåŠŸå®ç°äº†Mini LLMé›†æˆçš„æ ¸å¿ƒç›®æ ‡ï¼š
- âœ… é›¶æˆæœ¬æ–‡æœ¬å¤„ç†ï¼ˆDeepSeekå…è´¹ï¼‰
- âœ… çµæ´»çš„å¤šæ¨¡å‹æ”¯æŒ
- âœ… é«˜æ€§èƒ½ç¼“å­˜æœºåˆ¶
- âœ… ç”Ÿäº§çº§æ¶æ„è®¾è®¡

è™½ç„¶å­˜åœ¨å»¶è¿Ÿé—®é¢˜ï¼Œä½†é€šè¿‡ç¼“å­˜å’Œåç»­ä¼˜åŒ–å¯ä»¥æœ‰æ•ˆè§£å†³ã€‚ç³»ç»Ÿå·²å‡†å¤‡å¥½è¿›å…¥Phase 5çš„éƒ¨ç½²éªŒè¯é˜¶æ®µã€‚

---

**Phase 4çŠ¶æ€**: âœ… åŸºæœ¬å®Œæˆ
**ä¸‹ä¸€é˜¶æ®µ**: Phase 5 - éƒ¨ç½²å’ŒéªŒè¯


## äºŒã€è·¨é¡¹ç›®å…±äº«è®°å¿†ç³»ç»Ÿæ¶æ„ä¸éƒ¨ç½²

# è·¨é¡¹ç›®å…±äº«è®°å¿†ç³»ç»Ÿï¼šæ¶æ„è®¾è®¡æ–¹æ¡ˆ

## ğŸ¯ è®¾è®¡ç›®æ ‡

æœ¬ç³»ç»Ÿæ—¨åœ¨é€šè¿‡ PostgreSQL + Qdrant å‘é‡æ•°æ®åº“ï¼Œå®ç° **å¤šé¡¹ç›®å…±äº«çš„æŒä¹…è®°å¿†èƒ½åŠ›**ï¼ŒæœåŠ¡äº Claude Code CLI åœ¨å¤šä¸ªé¡¹ç›®ä¹‹é—´å¤ç”¨ä¸Šä¸‹æ–‡çš„éœ€æ±‚ã€‚

## ğŸ§± æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æè¿° |
|------|------|
| PostgreSQL | ç”¨äºå­˜å‚¨æ¶ˆæ¯å†…å®¹ã€conversation IDã€è§’è‰²ä¿¡æ¯ç­‰ç»“æ„åŒ–æ•°æ® |
| Qdrant | å‘é‡æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨ Embedding å‘é‡ï¼Œæ”¯æŒç›¸ä¼¼åº¦æ£€ç´¢ |
| Claude Memory Server | è‡ªç ”çš„ memory_serverï¼Œè´Ÿè´£è¯»å†™ PostgreSQL + Qdrantï¼Œå®ç°è®°å¿†è¯»å†™ API |
| Claude Code CLI | æ¥å…¥ memory_serverï¼Œé€šè¿‡ `.claude.json` è¿›è¡Œè®°å¿†äº¤äº’ |
| Mini LLM | ä¾‹å¦‚ Qwen3ã€Gemini Flashï¼Œç”¨äºå¤„ç†è®°å¿†èåˆã€å‹ç¼©ã€ä¸Šä¸‹æ–‡æ‹¼æ¥ç­‰ä»»åŠ¡ |

## ğŸ“ ç»Ÿä¸€é¡¹ç›®ç»“æ„å»ºè®®

```
claude_memory/
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ docker-compose.yml     â† å¯åŠ¨æ‰€æœ‰æœåŠ¡
â”‚   â”œâ”€â”€ .env.example           â† ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚   â””â”€â”€ Dockerfile             â† memory_serveré•œåƒæ„å»ºï¼ˆå¦‚æœ‰ï¼‰
â”œâ”€â”€ postgres/                  â† PostgreSQL volumeï¼ˆé¡¹ç›®å†…ï¼‰
â”œâ”€â”€ qdrant/                    â† Qdrant volumeï¼ˆé¡¹ç›®å†…ï¼‰
â”œâ”€â”€ memory_server/            â† MCPæœåŠ¡æ ¸å¿ƒä»£ç 
â”‚   â””â”€â”€ ...
```

## ğŸ”— å¤šé¡¹ç›®å…±äº«æ–¹å¼

- æ‰€æœ‰é¡¹ç›®åªéœ€åœ¨ Claude CLI é…ç½®ï¼ˆ`~/.claude.json`ï¼‰ä¸­æ·»åŠ  MCP æœåŠ¡å™¨åœ°å€
- ä¸åŒé¡¹ç›®çš„ `conversation_id` ç›¸äº’ç‹¬ç«‹ï¼Œä½†å¯å…±ç”¨æ•°æ®åº“
- åŒäº‹å¯æ ¹æ® `project_id + conversation_id` å®ç°éš”ç¦»æˆ–åˆå¹¶ç­–ç•¥

## âœ… ä¼˜ç‚¹

- ğŸ§³ è‡ªåŒ…å«å¼éƒ¨ç½²ï¼Œç”¨æˆ· clone é¡¹ç›®åå¯ç«‹å³éƒ¨ç½²
- ğŸ” æ”¯æŒè·¨é¡¹ç›®å…±äº«è®°å¿†
- ğŸ“¦ æ”¯æŒæ‰“åŒ…/åˆ†å‘ï¼Œæ— ä¾èµ–å¤–éƒ¨ç»“æ„

# è·¨é¡¹ç›®å…±äº«è®°å¿†ç³»ç»Ÿï¼šéƒ¨ç½²æ‰‹å†Œ

## ğŸ§° ç³»ç»Ÿä¾èµ–

- Docker >= 20.x
- Docker Compose >= v2.0
- Ubuntu 22.04
- GPU æ¨èï¼šRTX 4070 Ti Super (16GB)

---

## ğŸ—‚ï¸ é¡¹ç›®ç›®å½•ç»“æ„

```
claude_memory/
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”œâ”€â”€ .env.example
â”œâ”€â”€ postgres/
â”œâ”€â”€ qdrant/
â”œâ”€â”€ memory_server/
```

---

## ğŸ“ .env ç¤ºä¾‹

```
POSTGRES_PORT=5433
POSTGRES_DATA=./postgres

QDRANT_PORT=6333
QDRANT_DATA=./qdrant

MEMORY_API_PORT=7860
```

---

## â–¶ï¸ å¯åŠ¨æœåŠ¡

```bash
cd docker
cp .env.example .env
docker compose up -d
```

---

## ğŸ“¡ éªŒè¯æœåŠ¡æ˜¯å¦è¿è¡ŒæˆåŠŸ

```bash
# PostgreSQL
curl http://localhost:5433

# Qdrant
curl http://localhost:6333

# Claude Memory Server
curl http://localhost:7860/health
```

---

## ğŸ‘¥ åŒäº‹ä½¿ç”¨è¯´æ˜

### âœ… ç¬¬ä¸€æ¬¡éƒ¨ç½²æ­¥éª¤ï¼š

1. å…‹éš†é¡¹ç›®ï¼š

```bash
git clone https://github.com/xxx/claude_memory.git
cd claude_memory/docker
cp .env.example .env
docker compose up -d
```

2. é…ç½® Claude CLI è¿æ¥ï¼ˆç¼–è¾‘ `~/.claude.json`ï¼‰ï¼š

```json
{
  "mcpServers": {
    "claude-memory": {
      "type": "http",
      "url": "http://localhost:8000"
    }
  }
}
```

3. é‡å¯ Claude CLI æˆ– VS Code Claude Code

---

## ğŸ§  è®°å¿†å…±äº«è¯´æ˜

- æ‰€æœ‰ä¼šè¯æ•°æ®ç»Ÿä¸€å†™å…¥ `./postgres` ä¸ `./qdrant`
- æ”¯æŒå¤š conversation_id å¹¶å­˜
- æ¯ä¸ªé¡¹ç›®éƒ½å¯ä»¥å¤ç”¨è¿™å¥—è®°å¿†ç³»ç»Ÿï¼Œæ— éœ€é‡å¤éƒ¨ç½²

# ğŸš€ è·¨é¡¹ç›®å…±äº«è®°å¿†ç³»ç»Ÿäº¤ä»˜æ–¹æ¡ˆï¼ˆPostgreSQL + Qdrant + Qwen3 + GeminiFlashï¼‰

| ç›®æ ‡ | äº¤ä»˜æ•ˆæœ |
|------|----------|
| **ä¸€é”®éƒ¨ç½²** | åŒäº‹ clone ååªéœ€ 4 è¡Œå‘½ä»¤å³å¯å¯åŠ¨å®Œæ•´æ•°æ®åº“ & æœåŠ¡ |
| **è·¨é¡¹ç›®å…±äº«** | æ‰€æœ‰é¡¹ç›®å…±ç”¨ä¸€å¥— Postgres/Qdrant æ•°æ®å· |
| **æœ€å°æ”¹åŠ¨** | ä»£ç æœåŠ¡ç›®å½•ä¸å®¹å™¨ç¼–æ’å½»åº•éš”ç¦»ï¼›æºç æ— ç¡¬ç¼–ç è·¯å¾„ |
| **å¯è§£é‡Š** | æ¯ä¸€æ­¥åéƒ½é™„â€œä¸ºä»€ä¹ˆâ€è¯´æ˜ï¼Œä¾¿äº Claude ç†è§£ |

---

## ğŸ“ é¡¹ç›®ç»“æ„è§„åˆ’ï¼ˆæ¨èç»“æ„ï¼‰

```
/home/username/
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ postgres/       â† PostgreSQL æ•°æ®æŒ‚è½½ç›®å½•
â”‚   â””â”€â”€ qdrant/         â† Qdrant æ•°æ®æŒ‚è½½ç›®å½•
â”œâ”€â”€ project_a/
â”‚   â””â”€â”€ memory_server/
â”œâ”€â”€ project_b/
â”‚   â””â”€â”€ memory_server/
```

## âš™ï¸ æ­¥éª¤ä¸€ï¼šè®¾ç½® Docker Composeï¼ˆåœ¨æ¯ä¸ªé¡¹ç›®ä¸­ï¼‰

è·¯å¾„ï¼š`project_x/memory_server/docker/docker-compose.yml`

```yaml
version: "3.9"

services:
  postgres:
    image: postgres:15
    container_name: shared_postgres
    restart: always
    environment:
      POSTGRES_USER: shared
      POSTGRES_PASSWORD: shared
      POSTGRES_DB: memory
    volumes:
      - ../../db/postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  qdrant:
    image: qdrant/qdrant:v1.14.1
    container_name: shared_qdrant
    restart: always
    volumes:
      - ../../db/qdrant:/qdrant/storage
    ports:
      - "6333:6333"
      - "6334:6334"
```

### â“ ä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Ÿ

- ä½¿ç”¨ `../../db/`ï¼šä½¿æ‰€æœ‰é¡¹ç›®éƒ½èƒ½å…±äº«æ•°æ®åº“ï¼Œè€Œä¸æŠŠæ•°æ®æ”¾åœ¨ä»£ç ç›®å½•ä¸­
- åŒæ­¥å¯åŠ¨å®¹å™¨ï¼Œç»Ÿä¸€æœåŠ¡ç«¯å£
- PostgreSQL ä½¿ç”¨æ›´ç¨³å®šçš„ 15 ç‰ˆæœ¬

---

## ğŸ§ª æ­¥éª¤äºŒï¼šé¦–æ¬¡éƒ¨ç½²

æ¯ä½åŒäº‹ clone åï¼Œåªéœ€ï¼š

```bash
cd docker
docker-compose up -d
```

å³å¯å¯åŠ¨å®¹å™¨ã€‚

---

## ğŸ“¦ æ­¥éª¤ä¸‰ï¼šåœ¨ memory_server é…ç½®æ•°æ®åº“è¿æ¥

`.env` æ–‡ä»¶ä¸­è®¾ç½®ï¼š

```
POSTGRES_URL=postgresql://shared:shared@localhost:5432/memory
QDRANT_URL=http://localhost:6333
```

## ğŸ”„ æ­¥éª¤å››ï¼šEmbedding ä¸ Reranker è®¾ç½®ï¼ˆä»¥ Qwen3 ä¸ºä¾‹ï¼‰

å»ºè®®ä½¿ç”¨ SiliconFlow APIï¼š

```
EMBEDDING_MODEL=qwen3-embedding-8b
RERANKER_MODEL=qwen3-reranker-8b
```

---

## ğŸ“Š æ­¥éª¤äº”ï¼šå¯é€‰ - å¯åŠ¨ Gemini Flash å¾®æ¨¡å‹

ç”¨é€”ï¼šæ•´ç† Reranker è¾“å‡ºæˆ–ç”Ÿæˆæœ€ç»ˆæç¤ºè¯è¾“å‡ºã€‚éƒ¨ç½²æ–¹å¼å¯ç”¨ Claude CLI å†…ç½®å·¥å…·æˆ–è°ƒç”¨ Gemini Flash APIã€‚

---

## âœ… éªŒæ”¶æµç¨‹ï¼ˆClaude å¯è‡ªåŠ¨æ‰§è¡Œï¼‰

1. `docker-compose up -d` å¯åŠ¨æ•°æ®åº“
2. `.env` ä¸­é…ç½®æ•°æ®åº“åœ°å€
3. å¯åŠ¨ memory_serverï¼Œæ‰§è¡Œä¸€æ¬¡è®°å¿†å†™å…¥ï¼ˆEmbedding + Qdrantï¼‰
4. é‡å¯ memory_serverï¼ŒéªŒè¯è®°å¿†æ˜¯å¦èƒ½è¢«æ£€ç´¢
5. æ¢å¦ä¸€ä¸ªé¡¹ç›®ç›®å½•ï¼Œæ‰§è¡Œè®°å¿†å†™å…¥ï¼Œç¡®è®¤èƒ½å…±äº«åŒä¸€ Qdrant

---

> **è‡³æ­¤ï¼Œæ‰€æœ‰ç»†èŠ‚ã€ç†ç”±ã€åŒäº‹å¤ç°æ­¥éª¤å‡å·²é˜æ˜**ã€‚  
> ä½ å¯å°†æ­¤æ–‡ä»¶åŠ å…¥ä»“åº“ `docs/DEPLOY_SHARED_MEMORY_GUIDE.zh.md`ï¼Œå¹¶åœ¨ä»“åº“ `README` ä¸­å¼•ç”¨ã€‚Claude æ‹¿åˆ°åï¼Œä¼šå…ˆè¾“å‡ºã€Œä¿®æ”¹è®¡åˆ’ã€ï¼Œç„¶åæŒ‰æ­¥éª¤ç”Ÿæˆ / è°ƒæ•´æ–‡ä»¶å¹¶è¿è¡ŒéªŒè¯ã€‚


## ä¸‰ã€é¡¹ç›® README æ€»è§ˆ

# Claude Memory MCP Service

> ğŸ§  ä¸ºClaude CLIæä¾›é•¿æœŸè®°å¿†å’Œæ™ºèƒ½ä¸Šä¸‹æ–‡æ³¨å…¥èƒ½åŠ›çš„å®Œæ•´MCPæœåŠ¡

[![Docker](https://img.shields.io/badge/Docker-Ready-blue)](https://www.docker.com/)
[![Python](https://img.shields.io/badge/Python-3.8+-green)](https://www.python.org/)
[![License](https://img.shields.io/badge/License-MIT-yellow)](LICENSE)

## âœ¨ ç‰¹æ€§

- ğŸš€ **5åˆ†é’Ÿéƒ¨ç½²**: é›¶é…ç½®å¿«é€Ÿå¯åŠ¨ï¼Œæ”¯æŒWindows/macOS/Linux
- ğŸ“¦ **å®¹å™¨åŒ–æ¶æ„**: Docker Composeç®¡ç†ï¼Œè·¨å¹³å°å…¼å®¹
- ğŸ” **æ™ºèƒ½è®°å¿†æ£€ç´¢**: åŸºäºQdrantå‘é‡æ•°æ®åº“çš„è¯­ä¹‰æœç´¢
- ğŸ’¬ **è‡ªåŠ¨å¯¹è¯é‡‡é›†**: å®æ—¶æ•è·Claude CLIå¯¹è¯å¹¶æ™ºèƒ½å‹ç¼©
- ğŸŒ **è·¨é¡¹ç›®å…±äº«**: æ”¯æŒå¤šé¡¹ç›®é—´çš„è®°å¿†å…±äº«ï¼ˆå³å°†æ¨å‡ºï¼‰
- ğŸ¯ **Tokenä¼˜åŒ–**: æ™ºèƒ½æ§åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œæå‡æ•ˆç‡

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ5åˆ†é’Ÿéƒ¨ç½²ï¼‰

### å…ˆå†³æ¡ä»¶

- [Git](https://git-scm.com/)
- [Docker Desktop](https://www.docker.com/products/docker-desktop)

### éƒ¨ç½²æ­¥éª¤

#### Linux/macOS:
```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/your-repo/claude-memory.git
cd claude-memory

# 2. ä¸€é”®å¯åŠ¨
./scripts/start.sh
```

#### Windows (PowerShell):
```powershell
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/your-repo/claude-memory.git
cd claude-memory

# 2. å¯åŠ¨æœåŠ¡
docker compose up -d
```

### éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
./scripts/health-check.sh

# æŸ¥çœ‹æ—¥å¿—
./scripts/logs.sh
```

**å°±è¿™ä¹ˆç®€å•ï¼** ğŸ‰ æ‚¨çš„Claude MemoryæœåŠ¡å·²ç»åœ¨è¿è¡Œäº†ã€‚

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Claude Memory MCP Service                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®é‡‡é›†å±‚  â”‚ Collectors + å¯¹è¯è§£æ + æ•°æ®æ ‡å‡†åŒ–               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¯­ä¹‰å¤„ç†å±‚  â”‚ Processors + Fusers + å‘é‡åŒ– + è´¨é‡éªŒè¯         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å­˜å‚¨æ£€ç´¢å±‚  â”‚ PostgreSQL + Qdrant + ç¼“å­˜æœºåˆ¶                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ™ºèƒ½æ³¨å…¥å±‚  â”‚ Injectors + Builders + Tokenæ§åˆ¶                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ é…ç½®ï¼ˆå¯é€‰ï¼‰

ç³»ç»Ÿé»˜è®¤é…ç½®å³å¯è¿è¡Œã€‚å¦‚éœ€è‡ªå®šä¹‰ï¼š

1. **å¤åˆ¶é…ç½®æ¨¡æ¿**:
   ```bash
   cp .env.example .env
   ```

2. **ç¼–è¾‘ `.env` æ–‡ä»¶æ·»åŠ APIå¯†é’¥**:
   - `SILICONFLOW_API_KEY` - ç”¨äºå‘é‡åµŒå…¥ï¼ˆå¿…éœ€ï¼‰
   - `GEMINI_API_KEY` - ç”¨äºMini LLMå¤„ç†ï¼ˆå¯é€‰ï¼‰

3. **é‡å¯æœåŠ¡**:
   ```bash
   ./scripts/stop.sh && ./scripts/start.sh
   ```

## ğŸ”§ MCPå·¥å…·

| å·¥å…·å | åŠŸèƒ½ | ç¤ºä¾‹ |
|--------|------|---------|
| `search_memories` | æœç´¢å†å²è®°å¿† | æŸ¥æ‰¾ç›¸å…³æŠ€æœ¯è®¨è®º |
| `inject_context` | æ³¨å…¥æ™ºèƒ½ä¸Šä¸‹æ–‡ | å¢å¼ºå½“å‰å¯¹è¯ |
| `health_check` | ç³»ç»Ÿå¥åº·æ£€æŸ¥ | éªŒè¯æœåŠ¡çŠ¶æ€ |
| `get_stats` | è·å–æ€§èƒ½ç»Ÿè®¡ | ç›‘æ§ç³»ç»Ÿæ€§èƒ½ |

### ä½¿ç”¨ç¤ºä¾‹

```bash
# æœç´¢ç›¸å…³è®°å¿†
claude mcp claude-memory search_memories --query "Pythonæ€§èƒ½ä¼˜åŒ–"

# å¥åº·æ£€æŸ¥
claude mcp claude-memory health_check
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
claude-memory/
â”œâ”€â”€ src/claude_memory/      # æ ¸å¿ƒæœåŠ¡ä»£ç 
â”œâ”€â”€ scripts/                # éƒ¨ç½²å’Œç®¡ç†è„šæœ¬
â”œâ”€â”€ tests/                  # æµ‹è¯•å¥—ä»¶
â”œâ”€â”€ docs/                   # æ–‡æ¡£
â”œâ”€â”€ docker-compose.yml      # Dockeré…ç½®
â”œâ”€â”€ .env.example           # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ README.md              # æœ¬æ–‡æ¡£
```

## ğŸ” æ•…éšœæ’é™¤

### ç«¯å£è¢«å ç”¨

ç¼–è¾‘ `.env` æ–‡ä»¶æ›´æ”¹ç«¯å£ï¼š
```env
POSTGRES_PORT=5433      # é»˜è®¤: 5432
QDRANT_HTTP_PORT=6334   # é»˜è®¤: 6333
```

### Dockeræœªè¿è¡Œ

ç¡®ä¿Docker Desktopå·²å¯åŠ¨ï¼Œç„¶åé‡è¯•ã€‚

### æ›´å¤šé—®é¢˜ï¼Ÿ

æŸ¥çœ‹[å®Œæ•´æ–‡æ¡£](docs/README.md)æˆ–æäº¤[Issue](https://github.com/your-repo/claude-memory/issues)ã€‚

## ğŸ›£ï¸ è·¯çº¿å›¾

- [x] Phase 0: å¼€æºåŒ–æ”¹é€ ï¼ˆ5åˆ†é’Ÿéƒ¨ç½²ï¼‰
- [ ] Phase 1: é¡¹ç›®IDæœºåˆ¶
- [ ] Phase 2: æ•°æ®å±‚è·¨é¡¹ç›®æ”¯æŒ
- [ ] Phase 3: è·¨é¡¹ç›®æœç´¢èƒ½åŠ›
- [ ] Phase 4: Mini LLMé›†æˆ
- [ ] Phase 5: ç”Ÿäº§éƒ¨ç½²ä¼˜åŒ–

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ï¼è¯·æŸ¥çœ‹[è´¡çŒ®æŒ‡å—](CONTRIBUTING.md)äº†è§£è¯¦æƒ…ã€‚

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ™ è‡´è°¢

æ„Ÿè°¢Claude Codeå›¢é˜Ÿæä¾›ä¼˜ç§€çš„MCPæ¡†æ¶ã€‚

---

**æ¢ç´¢æ™ºèƒ½è®°å¿†ç®¡ç†çš„æ— é™å¯èƒ½ï¼** ğŸš€



---

## ğŸ“„ æ–‡ä»¶ï¼šå…±äº«è®°å¿†æ¶æ„è®¾è®¡_20250708_1734.md

# è·¨é¡¹ç›®å…±äº«è®°å¿†ç³»ç»Ÿï¼šæ¶æ„è®¾è®¡æ–¹æ¡ˆ

## ğŸ¯ è®¾è®¡ç›®æ ‡

æœ¬ç³»ç»Ÿæ—¨åœ¨é€šè¿‡ PostgreSQL + Qdrant å‘é‡æ•°æ®åº“ï¼Œå®ç° **å¤šé¡¹ç›®å…±äº«çš„æŒä¹…è®°å¿†èƒ½åŠ›**ï¼ŒæœåŠ¡äº Claude Code CLI åœ¨å¤šä¸ªé¡¹ç›®ä¹‹é—´å¤ç”¨ä¸Šä¸‹æ–‡çš„éœ€æ±‚ã€‚

## ğŸ§± æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æè¿° |
|------|------|
| PostgreSQL | ç”¨äºå­˜å‚¨æ¶ˆæ¯å†…å®¹ã€conversation IDã€è§’è‰²ä¿¡æ¯ç­‰ç»“æ„åŒ–æ•°æ® |
| Qdrant | å‘é‡æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨ Embedding å‘é‡ï¼Œæ”¯æŒç›¸ä¼¼åº¦æ£€ç´¢ |
| Claude Memory Server | è‡ªç ”çš„ memory_serverï¼Œè´Ÿè´£è¯»å†™ PostgreSQL + Qdrantï¼Œå®ç°è®°å¿†è¯»å†™ API |
| Claude Code CLI | æ¥å…¥ memory_serverï¼Œé€šè¿‡ `.claude.json` è¿›è¡Œè®°å¿†äº¤äº’ |
| Mini LLM | ä¾‹å¦‚ Qwen3ã€Gemini Flashï¼Œç”¨äºå¤„ç†è®°å¿†èåˆã€å‹ç¼©ã€ä¸Šä¸‹æ–‡æ‹¼æ¥ç­‰ä»»åŠ¡ |

## ğŸ“ ç»Ÿä¸€é¡¹ç›®ç»“æ„å»ºè®®

```
claude_memory/
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ docker-compose.yml     â† å¯åŠ¨æ‰€æœ‰æœåŠ¡
â”‚   â”œâ”€â”€ .env.example           â† ç¯å¢ƒå˜é‡æ¨¡æ¿
â”‚   â””â”€â”€ Dockerfile             â† memory_serveré•œåƒæ„å»ºï¼ˆå¦‚æœ‰ï¼‰
â”œâ”€â”€ postgres/                  â† PostgreSQL volumeï¼ˆé¡¹ç›®å†…ï¼‰
â”œâ”€â”€ qdrant/                    â† Qdrant volumeï¼ˆé¡¹ç›®å†…ï¼‰
â”œâ”€â”€ memory_server/            â† MCPæœåŠ¡æ ¸å¿ƒä»£ç 
â”‚   â””â”€â”€ ...
```

## ğŸ”— å¤šé¡¹ç›®å…±äº«æ–¹å¼

- æ‰€æœ‰é¡¹ç›®åªéœ€åœ¨ Claude CLI é…ç½®ï¼ˆ`~/.claude.json`ï¼‰ä¸­æ·»åŠ  MCP æœåŠ¡å™¨åœ°å€
- ä¸åŒé¡¹ç›®çš„ `conversation_id` ç›¸äº’ç‹¬ç«‹ï¼Œä½†å¯å…±ç”¨æ•°æ®åº“
- åŒäº‹å¯æ ¹æ® `project_id + conversation_id` å®ç°éš”ç¦»æˆ–åˆå¹¶ç­–ç•¥

## âœ… ä¼˜ç‚¹

- ğŸ§³ è‡ªåŒ…å«å¼éƒ¨ç½²ï¼Œç”¨æˆ· clone é¡¹ç›®åå¯ç«‹å³éƒ¨ç½²
- ğŸ” æ”¯æŒè·¨é¡¹ç›®å…±äº«è®°å¿†
- ğŸ“¦ æ”¯æŒæ‰“åŒ…/åˆ†å‘ï¼Œæ— ä¾èµ–å¤–éƒ¨ç»“æ„

---

## ğŸ“„ æ–‡ä»¶ï¼šå…±äº«è®°å¿†éƒ¨ç½²æ‰‹å†Œ_20250708_1734.md

# è·¨é¡¹ç›®å…±äº«è®°å¿†ç³»ç»Ÿï¼šéƒ¨ç½²æ‰‹å†Œ

## ğŸ§° ç³»ç»Ÿä¾èµ–

- Docker >= 20.x
- Docker Compose >= v2.0
- Ubuntu 22.04
- GPU æ¨èï¼šRTX 4070 Ti Super (16GB)

---

## ğŸ—‚ï¸ é¡¹ç›®ç›®å½•ç»“æ„

```
claude_memory/
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”œâ”€â”€ .env.example
â”œâ”€â”€ postgres/
â”œâ”€â”€ qdrant/
â”œâ”€â”€ memory_server/
```

---

## ğŸ“ .env ç¤ºä¾‹

```
POSTGRES_PORT=5433
POSTGRES_DATA=./postgres

QDRANT_PORT=6333
QDRANT_DATA=./qdrant

MEMORY_API_PORT=7860
```

---

## â–¶ï¸ å¯åŠ¨æœåŠ¡

```bash
cd docker
cp .env.example .env
docker compose up -d
```

---

## ğŸ“¡ éªŒè¯æœåŠ¡æ˜¯å¦è¿è¡ŒæˆåŠŸ

```bash
# PostgreSQL
curl http://localhost:5433

# Qdrant
curl http://localhost:6333

# Claude Memory Server
curl http://localhost:7860/health
```

---

## ğŸ‘¥ åŒäº‹ä½¿ç”¨è¯´æ˜

### âœ… ç¬¬ä¸€æ¬¡éƒ¨ç½²æ­¥éª¤ï¼š

1. å…‹éš†é¡¹ç›®ï¼š

```bash
git clone https://github.com/xxx/claude_memory.git
cd claude_memory/docker
cp .env.example .env
docker compose up -d
```

2. é…ç½® Claude CLI è¿æ¥ï¼ˆç¼–è¾‘ `~/.claude.json`ï¼‰ï¼š

```json
{
  "mcpServers": {
    "claude-memory": {
      "type": "http",
      "url": "http://localhost:8000"
    }
  }
}
```

3. é‡å¯ Claude CLI æˆ– VS Code Claude Code

---

## ğŸ§  è®°å¿†å…±äº«è¯´æ˜

- æ‰€æœ‰ä¼šè¯æ•°æ®ç»Ÿä¸€å†™å…¥ `./postgres` ä¸ `./qdrant`
- æ”¯æŒå¤š conversation_id å¹¶å­˜
- æ¯ä¸ªé¡¹ç›®éƒ½å¯ä»¥å¤ç”¨è¿™å¥—è®°å¿†ç³»ç»Ÿï¼Œæ— éœ€é‡å¤éƒ¨ç½²

---

## ğŸ“„ æ–‡ä»¶ï¼šè·¨é¡¹ç›®å…±äº«è®°å¿†ç³»ç»Ÿäº¤ä»˜æ–¹æ¡ˆ.md


# ğŸš€ è·¨é¡¹ç›®å…±äº«è®°å¿†ç³»ç»Ÿäº¤ä»˜æ–¹æ¡ˆï¼ˆPostgreSQL + Qdrant + Qwen3 + GeminiFlashï¼‰

| ç›®æ ‡ | äº¤ä»˜æ•ˆæœ |
|------|----------|
| **ä¸€é”®éƒ¨ç½²** | åŒäº‹ clone ååªéœ€ 4 è¡Œå‘½ä»¤å³å¯å¯åŠ¨å®Œæ•´æ•°æ®åº“ & æœåŠ¡ |
| **è·¨é¡¹ç›®å…±äº«** | æ‰€æœ‰é¡¹ç›®å…±ç”¨ä¸€å¥— Postgres/Qdrant æ•°æ®å· |
| **æœ€å°æ”¹åŠ¨** | ä»£ç æœåŠ¡ç›®å½•ä¸å®¹å™¨ç¼–æ’å½»åº•éš”ç¦»ï¼›æºç æ— ç¡¬ç¼–ç è·¯å¾„ |
| **å¯è§£é‡Š** | æ¯ä¸€æ­¥åéƒ½é™„â€œä¸ºä»€ä¹ˆâ€è¯´æ˜ï¼Œä¾¿äº Claude ç†è§£ |

---

## ğŸ“ é¡¹ç›®ç»“æ„è§„åˆ’ï¼ˆæ¨èç»“æ„ï¼‰

```
/home/username/
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ postgres/       â† PostgreSQL æ•°æ®æŒ‚è½½ç›®å½•
â”‚   â””â”€â”€ qdrant/         â† Qdrant æ•°æ®æŒ‚è½½ç›®å½•
â”œâ”€â”€ project_a/
â”‚   â””â”€â”€ memory_server/
â”œâ”€â”€ project_b/
â”‚   â””â”€â”€ memory_server/
```

## âš™ï¸ æ­¥éª¤ä¸€ï¼šè®¾ç½® Docker Composeï¼ˆåœ¨æ¯ä¸ªé¡¹ç›®ä¸­ï¼‰

è·¯å¾„ï¼š`project_x/memory_server/docker/docker-compose.yml`

```yaml
version: "3.9"

services:
  postgres:
    image: postgres:15
    container_name: shared_postgres
    restart: always
    environment:
      POSTGRES_USER: shared
      POSTGRES_PASSWORD: shared
      POSTGRES_DB: memory
    volumes:
      - ../../db/postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  qdrant:
    image: qdrant/qdrant:v1.14.1
    container_name: shared_qdrant
    restart: always
    volumes:
      - ../../db/qdrant:/qdrant/storage
    ports:
      - "6333:6333"
      - "6334:6334"
```

### â“ ä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼Ÿ

- ä½¿ç”¨ `../../db/`ï¼šä½¿æ‰€æœ‰é¡¹ç›®éƒ½èƒ½å…±äº«æ•°æ®åº“ï¼Œè€Œä¸æŠŠæ•°æ®æ”¾åœ¨ä»£ç ç›®å½•ä¸­
- åŒæ­¥å¯åŠ¨å®¹å™¨ï¼Œç»Ÿä¸€æœåŠ¡ç«¯å£
- PostgreSQL ä½¿ç”¨æ›´ç¨³å®šçš„ 15 ç‰ˆæœ¬

---

## ğŸ§ª æ­¥éª¤äºŒï¼šé¦–æ¬¡éƒ¨ç½²

æ¯ä½åŒäº‹ clone åï¼Œåªéœ€ï¼š

```bash
cd docker
docker-compose up -d
```

å³å¯å¯åŠ¨å®¹å™¨ã€‚

---

## ğŸ“¦ æ­¥éª¤ä¸‰ï¼šåœ¨ memory_server é…ç½®æ•°æ®åº“è¿æ¥

`.env` æ–‡ä»¶ä¸­è®¾ç½®ï¼š

```
POSTGRES_URL=postgresql://shared:shared@localhost:5432/memory
QDRANT_URL=http://localhost:6333
```

## ğŸ”„ æ­¥éª¤å››ï¼šEmbedding ä¸ Reranker è®¾ç½®ï¼ˆä»¥ Qwen3 ä¸ºä¾‹ï¼‰

å»ºè®®ä½¿ç”¨ SiliconFlow APIï¼š

```
EMBEDDING_MODEL=qwen3-embedding-8b
RERANKER_MODEL=qwen3-reranker-8b
```

---

## ğŸ“Š æ­¥éª¤äº”ï¼šå¯é€‰ - å¯åŠ¨ Gemini Flash å¾®æ¨¡å‹

ç”¨é€”ï¼šæ•´ç† Reranker è¾“å‡ºæˆ–ç”Ÿæˆæœ€ç»ˆæç¤ºè¯è¾“å‡ºã€‚éƒ¨ç½²æ–¹å¼å¯ç”¨ Claude CLI å†…ç½®å·¥å…·æˆ–è°ƒç”¨ Gemini Flash APIã€‚

---

## âœ… éªŒæ”¶æµç¨‹ï¼ˆClaude å¯è‡ªåŠ¨æ‰§è¡Œï¼‰

1. `docker-compose up -d` å¯åŠ¨æ•°æ®åº“
2. `.env` ä¸­é…ç½®æ•°æ®åº“åœ°å€
3. å¯åŠ¨ memory_serverï¼Œæ‰§è¡Œä¸€æ¬¡è®°å¿†å†™å…¥ï¼ˆEmbedding + Qdrantï¼‰
4. é‡å¯ memory_serverï¼ŒéªŒè¯è®°å¿†æ˜¯å¦èƒ½è¢«æ£€ç´¢
5. æ¢å¦ä¸€ä¸ªé¡¹ç›®ç›®å½•ï¼Œæ‰§è¡Œè®°å¿†å†™å…¥ï¼Œç¡®è®¤èƒ½å…±äº«åŒä¸€ Qdrant

---

> **è‡³æ­¤ï¼Œæ‰€æœ‰ç»†èŠ‚ã€ç†ç”±ã€åŒäº‹å¤ç°æ­¥éª¤å‡å·²é˜æ˜**ã€‚  
> ä½ å¯å°†æ­¤æ–‡ä»¶åŠ å…¥ä»“åº“ `docs/DEPLOY_SHARED_MEMORY_GUIDE.zh.md`ï¼Œå¹¶åœ¨ä»“åº“ `README` ä¸­å¼•ç”¨ã€‚Claude æ‹¿åˆ°åï¼Œä¼šå…ˆè¾“å‡ºã€Œä¿®æ”¹è®¡åˆ’ã€ï¼Œç„¶åæŒ‰æ­¥éª¤ç”Ÿæˆ / è°ƒæ•´æ–‡ä»¶å¹¶è¿è¡ŒéªŒè¯ã€‚


---

## ğŸ“„ æ–‡ä»¶ï¼šCROSS_PROJECT_SEARCH_FULL.md

# ğŸ“˜ è·¨é¡¹ç›®æœç´¢åŠŸèƒ½ï¼ˆå®Œæ•´æ–‡æ¡£ï¼‰

---

## ğŸ“– æ–‡ä»¶ä¸€ï¼šåŠŸèƒ½æ–‡æ¡£

# è·¨é¡¹ç›®æœç´¢åŠŸèƒ½æ–‡æ¡£

## æ¦‚è¿°

è·¨é¡¹ç›®æœç´¢åŠŸèƒ½å…è®¸ Claude Memory MCP Service åœ¨å¤šä¸ªé¡¹ç›®ä¸­åŒæ—¶æœç´¢ç›¸å…³è®°å¿†ï¼Œå®ç°çŸ¥è¯†çš„è·¨é¡¹ç›®å¤ç”¨å’Œå…³è”ã€‚è¿™å¯¹äºå¤§å‹å¼€å‘å›¢é˜Ÿã€å¤šé¡¹ç›®ç®¡ç†å’ŒçŸ¥è¯†ç®¡ç†åœºæ™¯ç‰¹åˆ«æœ‰ç”¨ã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. å¤šé¡¹ç›®å¹¶è¡Œæœç´¢
- æ”¯æŒåŒæ—¶åœ¨å¤šä¸ªé¡¹ç›®ä¸­æœç´¢è®°å¿†
- å¹¶è¡Œæ‰§è¡Œæé«˜æœç´¢æ•ˆç‡
- è‡ªåŠ¨åˆå¹¶å’Œæ’åºç»“æœ

### 2. çµæ´»çš„æœç´¢èŒƒå›´
- æŒ‡å®šç‰¹å®šé¡¹ç›®åˆ—è¡¨æœç´¢
- æœç´¢æ‰€æœ‰æ´»è·ƒé¡¹ç›®
- æ”¯æŒé¡¹ç›®æƒé™æ§åˆ¶ï¼ˆå¾…å®ç°ï¼‰

### 3. å¤šç§åˆå¹¶ç­–ç•¥
- **score**: æŒ‰ç›¸å…³æ€§åˆ†æ•°æ’åºï¼ˆé»˜è®¤ï¼‰
- **time**: æŒ‰æ—¶é—´æ’åºï¼ˆæœ€æ–°ä¼˜å…ˆï¼‰
- **project**: æŒ‰é¡¹ç›®è½®æµå–ç»“æœ

### 4. æœç´¢ç»“æœç»Ÿè®¡
- æ¯ä¸ªé¡¹ç›®çš„æœç´¢ç»“æœæ•°
- æ€»æœç´¢æ—¶é—´
- é¡¹ç›®çº§åˆ«çš„ç»Ÿè®¡ä¿¡æ¯

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒç»„ä»¶

1. **CrossProjectSearchManager**
   - ä½ç½®ï¼š`src/claude_memory/managers/cross_project_search.py`
   - è´Ÿè´£åè°ƒè·¨é¡¹ç›®æœç´¢çš„æ‰§è¡Œ
   - å¤„ç†ç»“æœåˆå¹¶å’Œæ’åº

2. **æ•°æ®æ¨¡å‹**
   ```python
   class CrossProjectSearchRequest(BaseModel):
       query: SearchQuery              # æœç´¢æŸ¥è¯¢
       project_ids: Optional[List[str]] # æŒ‡å®šé¡¹ç›®IDåˆ—è¡¨
       include_all_projects: bool      # æ˜¯å¦æœç´¢æ‰€æœ‰é¡¹ç›®
       merge_strategy: str             # åˆå¹¶ç­–ç•¥
       max_results_per_project: int    # æ¯ä¸ªé¡¹ç›®æœ€å¤§ç»“æœæ•°
   
   class CrossProjectSearchResponse(BaseModel):
       results: List[SearchResult]     # åˆå¹¶åçš„ç»“æœ
       project_results: Dict[str, CrossProjectSearchResult] # æŒ‰é¡¹ç›®åˆ†ç»„
       total_count: int                # æ€»ç»“æœæ•°
       projects_searched: int          # æœç´¢çš„é¡¹ç›®æ•°
       search_time_ms: float          # æœç´¢è€—æ—¶
   ```

3. **MCPå·¥å…·æ¥å£**
   - å·¥å…·åç§°ï¼š`claude_memory_cross_project_search`
   - æ”¯æŒå‚æ•°ï¼š
     - query: æœç´¢æ–‡æœ¬
     - project_ids: é¡¹ç›®IDåˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
     - include_all_projects: æ˜¯å¦æœç´¢æ‰€æœ‰é¡¹ç›®
     - merge_strategy: ç»“æœåˆå¹¶ç­–ç•¥
     - max_results_per_project: æ¯ä¸ªé¡¹ç›®è¿”å›çš„æœ€å¤§ç»“æœæ•°

### é…ç½®é¡¹

åœ¨ `settings.py` ä¸­çš„ `ProjectSettings`ï¼š

```python
class ProjectSettings(BaseSettings):
    enable_cross_project_search: bool = False  # æ˜¯å¦å¯ç”¨è·¨é¡¹ç›®æœç´¢
    max_projects_per_search: int = 5          # æ¯æ¬¡æœç´¢æœ€å¤šæ¶‰åŠçš„é¡¹ç›®æ•°
    project_isolation_mode: str = "strict"    # é¡¹ç›®éš”ç¦»æ¨¡å¼
```

### æ•°æ®åº“æ”¯æŒ

- `conversations` è¡¨åŒ…å« `project_id` å­—æ®µ
- `memory_units` è¡¨å·²æ·»åŠ  `project_id` å­—æ®µ
- å»ºç«‹äº†ç›¸å…³ç´¢å¼•ä»¥ä¼˜åŒ–è·¨é¡¹ç›®æŸ¥è¯¢æ€§èƒ½

## ä½¿ç”¨ç¤ºä¾‹

### 1. é€šè¿‡ MCP å·¥å…·æœç´¢ç‰¹å®šé¡¹ç›®

```json
{
  "tool": "claude_memory_cross_project_search",
  "arguments": {
    "query": "Pythonç¼–ç¨‹æœ€ä½³å®è·µ",
    "project_ids": ["project-a", "project-b", "project-c"],
    "merge_strategy": "score",
    "max_results_per_project": 10
  }
}
```

### 2. æœç´¢æ‰€æœ‰æ´»è·ƒé¡¹ç›®

```json
{
  "tool": "claude_memory_cross_project_search",
  "arguments": {
    "query": "APIè®¾è®¡",
    "include_all_projects": true,
    "merge_strategy": "time",
    "limit": 20
  }
}
```

### 3. é€šè¿‡ Python API ä½¿ç”¨

```python
from claude_memory.managers.service_manager import ServiceManager
from claude_memory.managers.cross_project_search import CrossProjectSearchRequest
from claude_memory.models.data_models import SearchQuery

# åˆå§‹åŒ–æœåŠ¡ç®¡ç†å™¨
service_manager = ServiceManager()
await service_manager.start_service()

# æ„å»ºæœç´¢è¯·æ±‚
search_query = SearchQuery(
    query="å¾®æœåŠ¡æ¶æ„",
    query_type="hybrid",
    limit=50
)

cross_search_request = CrossProjectSearchRequest(
    query=search_query,
    project_ids=["backend", "frontend", "infra"],
    merge_strategy="score",
    max_results_per_project=20
)

# æ‰§è¡Œè·¨é¡¹ç›®æœç´¢
response = await service_manager.search_memories_cross_project(cross_search_request)

# å¤„ç†ç»“æœ
for result in response.results:
    print(f"é¡¹ç›®: {result.metadata.get('project_name')}")
    print(f"æ ‡é¢˜: {result.memory_unit.title}")
    print(f"ç›¸å…³æ€§: {result.relevance_score}")
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶è¡Œæœç´¢
- ä½¿ç”¨ `asyncio.gather` å¹¶è¡Œæ‰§è¡Œå¤šä¸ªé¡¹ç›®çš„æœç´¢
- æ˜¾è‘—å‡å°‘æ€»ä½“æœç´¢æ—¶é—´

### 2. ç»“æœé™åˆ¶
- `max_results_per_project` é™åˆ¶æ¯ä¸ªé¡¹ç›®çš„ç»“æœæ•°
- `max_projects_per_search` é™åˆ¶æœç´¢çš„é¡¹ç›®æ€»æ•°
- é¿å…è¿”å›è¿‡å¤šç»“æœå½±å“æ€§èƒ½

### 3. ç´¢å¼•ä¼˜åŒ–
- åˆ›å»º `(project_id, unit_type, created_at)` å¤åˆç´¢å¼•
- ä¼˜åŒ–æŒ‰é¡¹ç›®å’Œç±»å‹çš„æŸ¥è¯¢æ€§èƒ½

## å®‰å…¨æ€§è€ƒè™‘

### 1. é¡¹ç›®æƒé™ï¼ˆå¾…å®ç°ï¼‰
- éªŒè¯ç”¨æˆ·å¯¹è¯·æ±‚é¡¹ç›®çš„è®¿é—®æƒé™
- é˜²æ­¢æœªæˆæƒçš„è·¨é¡¹ç›®æ•°æ®è®¿é—®

### 2. é…ç½®æ§åˆ¶
- `enable_cross_project_search` é»˜è®¤å…³é—­
- éœ€è¦æ˜¾å¼å¯ç”¨æ‰èƒ½ä½¿ç”¨è·¨é¡¹ç›®æœç´¢

### 3. é¡¹ç›®éš”ç¦»æ¨¡å¼
- **strict**: ä¸¥æ ¼éš”ç¦»ï¼Œé»˜è®¤ä¸å…è®¸è·¨é¡¹ç›®è®¿é—®
- **relaxed**: å®½æ¾éš”ç¦»ï¼Œå…è®¸æœ‰é™çš„è·¨é¡¹ç›®è®¿é—®
- **shared**: å…±äº«æ¨¡å¼ï¼Œå…è®¸å®Œå…¨çš„è·¨é¡¹ç›®è®¿é—®

## æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½å½±å“**
   - è·¨é¡¹ç›®æœç´¢ä¼šå¢åŠ ç³»ç»Ÿè´Ÿè½½
   - å»ºè®®åˆç†è®¾ç½®æœç´¢é™åˆ¶å‚æ•°

2. **æ•°æ®ä¸€è‡´æ€§**
   - ç¡®ä¿æ‰€æœ‰è®°å¿†å•å…ƒéƒ½æœ‰æ­£ç¡®çš„ project_id
   - è¿è¡Œè¿ç§»è„šæœ¬æ›´æ–°å†å²æ•°æ®

3. **å‘åå…¼å®¹**
   - æ–°å¢åŠŸèƒ½ä¸å½±å“ç°æœ‰çš„å•é¡¹ç›®æœç´¢
   - é»˜è®¤è¡Œä¸ºä¿æŒä¸å˜

## åç»­è®¡åˆ’

1. **Phase 3 å‰©ä½™ä»»åŠ¡**
   - å®ç°é¡¹ç›®çº§åˆ«çš„æƒé™æ§åˆ¶
   - æ·»åŠ æœç´¢ç»“æœçš„è®¿é—®æ§åˆ¶

2. **ä¼˜åŒ–æ–¹å‘**
   - å®ç°æœç´¢ç»“æœç¼“å­˜
   - æ·»åŠ æœç´¢å†å²è®°å½•
   - æ”¯æŒæ›´å¤æ‚çš„æŸ¥è¯¢æ¡ä»¶

3. **æ‰©å±•åŠŸèƒ½**
   - é¡¹ç›®é—´çš„çŸ¥è¯†å›¾è°±æ„å»º
   - è·¨é¡¹ç›®çš„æ™ºèƒ½æ¨è
   - é¡¹ç›®ç›¸ä¼¼åº¦åˆ†æ

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **"Cross-project search is not enabled" é”™è¯¯**
   - è§£å†³ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ `PROJECT__ENABLE_CROSS_PROJECT_SEARCH=true`
   - æˆ–åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨è¯¥åŠŸèƒ½

2. **æœç´¢ç»“æœä¸ºç©º**
   - æ£€æŸ¥é¡¹ç›®IDæ˜¯å¦æ­£ç¡®
   - ç¡®è®¤é¡¹ç›®ä¸­æ˜¯å¦æœ‰ç›¸å…³è®°å¿†
   - éªŒè¯æœç´¢å…³é”®è¯

3. **æ€§èƒ½é—®é¢˜**
   - å‡å°‘ `max_results_per_project`
   - é™åˆ¶æœç´¢çš„é¡¹ç›®æ•°é‡
   - æ£€æŸ¥æ•°æ®åº“ç´¢å¼•æ˜¯å¦æ­£ç¡®åˆ›å»º

## æ€»ç»“

è·¨é¡¹ç›®æœç´¢åŠŸèƒ½ä¸º Claude Memory MCP Service å¸¦æ¥äº†å¼ºå¤§çš„çŸ¥è¯†ç®¡ç†èƒ½åŠ›ï¼Œä½¿å¾—ä¸åŒé¡¹ç›®é—´çš„çŸ¥è¯†å¯ä»¥æœ‰æ•ˆå…±äº«å’Œå¤ç”¨ã€‚é€šè¿‡åˆç†çš„é…ç½®å’Œä½¿ç”¨ï¼Œå¯ä»¥å¤§å¤§æå‡å›¢é˜Ÿçš„çŸ¥è¯†ç®¡ç†æ•ˆç‡ã€‚

---

## ğŸ“˜ æ–‡ä»¶äºŒï¼šåŠŸèƒ½ä½¿ç”¨æŒ‡å—

# è·¨é¡¹ç›®æœç´¢åŠŸèƒ½æŒ‡å—

## æ¦‚è¿°

Claude Memory MCP Service ç°åœ¨æ”¯æŒè·¨é¡¹ç›®æœç´¢åŠŸèƒ½ï¼Œå…è®¸æ‚¨åœ¨å¤šä¸ªé¡¹ç›®ä¹‹é—´æœç´¢å’Œå…±äº«è®°å¿†ã€‚è¿™ä¸ªåŠŸèƒ½ç‰¹åˆ«é€‚åˆéœ€è¦è·¨é¡¹ç›®åä½œæˆ–éœ€è¦è®¿é—®å…¶ä»–é¡¹ç›®å†å²çŸ¥è¯†çš„åœºæ™¯ã€‚

## åŠŸèƒ½ç‰¹æ€§

### 1. å¤šé¡¹ç›®å¹¶è¡Œæœç´¢
- æ”¯æŒåŒæ—¶åœ¨å¤šä¸ªé¡¹ç›®ä¸­æœç´¢è®°å¿†
- ä½¿ç”¨å¼‚æ­¥å¹¶è¡Œå¤„ç†æé«˜æœç´¢æ•ˆç‡
- å¯ä»¥æœç´¢æ‰€æœ‰æ´»è·ƒé¡¹ç›®æˆ–æŒ‡å®šé¡¹ç›®åˆ—è¡¨

### 2. æ™ºèƒ½ç»“æœåˆå¹¶
æä¾›ä¸‰ç§åˆå¹¶ç­–ç•¥ï¼š
- **score** (é»˜è®¤): æŒ‰ç›¸å…³æ€§åˆ†æ•°æ’åºï¼Œæœ€ç›¸å…³çš„ç»“æœä¼˜å…ˆ
- **time**: æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„è®°å¿†ä¼˜å…ˆ
- **project**: é¡¹ç›®è½®è¯¢ç­–ç•¥ï¼Œç¡®ä¿æ¯ä¸ªé¡¹ç›®çš„ç»“æœå‡åŒ€åˆ†å¸ƒ

### 3. é¡¹ç›®æƒé™æ§åˆ¶
- åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC)
- æƒé™çº§åˆ«ï¼šNONEã€READã€WRITEã€ADMINã€OWNER
- ç³»ç»Ÿç”¨æˆ·æ‹¥æœ‰æ‰€æœ‰é¡¹ç›®çš„å®Œå…¨è®¿é—®æƒé™
- æ”¯æŒä¸´æ—¶æƒé™æˆäºˆ

### 4. é¡¹ç›®éš”ç¦»æ¨¡å¼
ä¸‰ç§éš”ç¦»æ¨¡å¼ï¼š
- **strict**: ä¸¥æ ¼éš”ç¦»ï¼Œç¦æ­¢è·¨é¡¹ç›®è®¿é—®ï¼ˆé™¤éæ˜¾å¼å¯ç”¨ï¼‰
- **relaxed**: å®½æ¾éš”ç¦»ï¼Œå…è®¸æœ‰æƒé™çš„è·¨é¡¹ç›®è®¿é—®
- **shared**: å…±äº«æ¨¡å¼ï¼Œé¡¹ç›®é—´å¯ä»¥è‡ªç”±å…±äº«è®°å¿†

## ä½¿ç”¨æ–¹æ³•

### é€šè¿‡ MCP å·¥å…·ä½¿ç”¨

```json
{
  "tool": "claude_memory_cross_project_search",
  "arguments": {
    "query": "æœç´¢å…³é”®è¯",
    "project_ids": ["project1", "project2"],
    "merge_strategy": "score",
    "max_results_per_project": 10,
    "user_id": "user123"
  }
}
```

å‚æ•°è¯´æ˜ï¼š
- **query**: æœç´¢æŸ¥è¯¢æ–‡æœ¬ï¼ˆå¿…éœ€ï¼‰
- **project_ids**: è¦æœç´¢çš„é¡¹ç›®IDåˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
- **include_all_projects**: æ˜¯å¦æœç´¢æ‰€æœ‰æ´»è·ƒé¡¹ç›®ï¼ˆå¯é€‰ï¼Œé»˜è®¤ falseï¼‰
- **merge_strategy**: ç»“æœåˆå¹¶ç­–ç•¥ï¼ˆå¯é€‰ï¼Œé»˜è®¤ "score"ï¼‰
- **max_results_per_project**: æ¯ä¸ªé¡¹ç›®çš„æœ€å¤§ç»“æœæ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 10ï¼‰
- **user_id**: ç”¨æˆ·IDï¼Œç”¨äºæƒé™éªŒè¯ï¼ˆå¯é€‰ï¼‰

### å“åº”æ ¼å¼

```json
{
  "success": true,
  "query": "æœç´¢å…³é”®è¯",
  "results": [
    {
      "id": "memory-id",
      "title": "è®°å¿†æ ‡é¢˜",
      "summary": "è®°å¿†æ‘˜è¦",
      "relevance_score": 0.95,
      "project_id": "project1",
      "project_name": "é¡¹ç›®1"
    }
  ],
  "project_stats": {
    "project1": {
      "name": "é¡¹ç›®1",
      "count": 5,
      "total": 10
    }
  },
  "total_found": 15,
  "projects_searched": 2,
  "search_time_ms": 150
}
```

## é…ç½®é€‰é¡¹

åœ¨ `config.yaml` ä¸­é…ç½®è·¨é¡¹ç›®æœç´¢ï¼š

```yaml
project:
  enable_cross_project_search: true  # å¯ç”¨è·¨é¡¹ç›®æœç´¢
  project_isolation_mode: "relaxed"   # é¡¹ç›®éš”ç¦»æ¨¡å¼
  max_projects_per_search: 10         # å•æ¬¡æœç´¢çš„æœ€å¤§é¡¹ç›®æ•°
  default_project_id: "default"       # é»˜è®¤é¡¹ç›®ID
```

## æƒé™ç®¡ç†

### æˆäºˆæƒé™

```python
# æˆäºˆç”¨æˆ·å¯¹é¡¹ç›®çš„è¯»æƒé™
permission_manager.grant_permission(
    user_id="user123",
    project_id="project1",
    permission_level=PermissionLevel.READ,
    granted_by="admin"
)
```

### æƒé™æ£€æŸ¥

ç³»ç»Ÿä¼šè‡ªåŠ¨è¿›è¡Œæƒé™æ£€æŸ¥ï¼š
1. ç”¨æˆ·è¯·æ±‚è·¨é¡¹ç›®æœç´¢
2. ç³»ç»Ÿæ£€æŸ¥ç”¨æˆ·å¯¹æ¯ä¸ªé¡¹ç›®çš„æƒé™
3. åªæœç´¢ç”¨æˆ·æœ‰æƒé™è®¿é—®çš„é¡¹ç›®
4. è¿”å›ç»“æœä¸­æ ‡æ˜æ¯ä¸ªè®°å¿†æ¥æºçš„é¡¹ç›®

## æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½®é¡¹ç›®éš”ç¦»æ¨¡å¼**
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ "strict" æˆ– "relaxed" æ¨¡å¼
   - å¼€å‘ç¯å¢ƒå¯ä»¥ä½¿ç”¨ "shared" æ¨¡å¼æ–¹ä¾¿æµ‹è¯•

2. **æ§åˆ¶æœç´¢èŒƒå›´**
   - é¿å…ä¸€æ¬¡æœç´¢è¿‡å¤šé¡¹ç›®ï¼Œå½±å“æ€§èƒ½
   - ä½¿ç”¨ `max_results_per_project` é™åˆ¶æ¯ä¸ªé¡¹ç›®çš„ç»“æœæ•°

3. **æƒé™ç®¡ç†**
   - å®šæœŸå®¡æ ¸ç”¨æˆ·æƒé™
   - ä½¿ç”¨æœ€å°æƒé™åŸåˆ™
   - è€ƒè™‘ä½¿ç”¨ä¸´æ—¶æƒé™è€Œéæ°¸ä¹…æƒé™

4. **æ€§èƒ½ä¼˜åŒ–**
   - è·¨é¡¹ç›®æœç´¢ä½¿ç”¨å¼‚æ­¥å¹¶è¡Œå¤„ç†
   - åˆç†è®¾ç½® `max_projects_per_search` é™åˆ¶
   - ç›‘æ§æœç´¢æ€§èƒ½ï¼ŒåŠæ—¶ä¼˜åŒ–ç´¢å¼•

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **æ•°æ®éš”ç¦»**ï¼šç¡®ä¿æ•æ„Ÿé¡¹ç›®ä½¿ç”¨ä¸¥æ ¼éš”ç¦»æ¨¡å¼
2. **æƒé™å®¡è®¡**ï¼šå®šæœŸæ£€æŸ¥å’Œå®¡è®¡è·¨é¡¹ç›®è®¿é—®æ—¥å¿—
3. **æœ€å°æƒé™**ï¼šåªæˆäºˆå¿…è¦çš„è·¨é¡¹ç›®è®¿é—®æƒé™
4. **è®¿é—®æ§åˆ¶**ï¼šä½¿ç”¨é¡¹ç›®çº§åˆ«çš„ç»†ç²’åº¦æƒé™æ§åˆ¶

## æ•…éšœæ’é™¤

### æ— æ³•æœç´¢å…¶ä»–é¡¹ç›®
- æ£€æŸ¥ `enable_cross_project_search` æ˜¯å¦å¯ç”¨
- ç¡®è®¤ç”¨æˆ·å¯¹ç›®æ ‡é¡¹ç›®æœ‰è¯»æƒé™
- æ£€æŸ¥é¡¹ç›®éš”ç¦»æ¨¡å¼è®¾ç½®

### æœç´¢ç»“æœä¸ºç©º
- ç¡®è®¤ç›®æ ‡é¡¹ç›®ä¸­æœ‰ç›¸å…³è®°å¿†
- æ£€æŸ¥æœç´¢æŸ¥è¯¢æ˜¯å¦æ­£ç¡®
- éªŒè¯é¡¹ç›®IDæ˜¯å¦æœ‰æ•ˆä¸”é¡¹ç›®å¤„äºæ´»è·ƒçŠ¶æ€

### æ€§èƒ½é—®é¢˜
- å‡å°‘åŒæ—¶æœç´¢çš„é¡¹ç›®æ•°é‡
- é™ä½ `max_results_per_project` å€¼
- æ£€æŸ¥æ•°æ®åº“ç´¢å¼•æ˜¯å¦æ­£å¸¸


---

## ğŸ“„ æ–‡ä»¶ï¼šPHASE3_INTEGRATION_COMPLETE_REPORT.md

# Claude Memory MCPæœåŠ¡ - Phase 3é›†æˆå®ŒæˆæŠ¥å‘Š

## æ‰§è¡Œæ¦‚è¦

**é¡¹ç›®åç§°**: Claude Memory MCPæœåŠ¡ - æ¨¡å—é›†æˆä¸éƒ¨ç½²ä¼˜åŒ–  
**æ‰§è¡Œæ—¶é—´**: 2024-01-09  
**æ‰§è¡Œäºº**: Claude Assistant  
**ä»»åŠ¡æ¥æº**: Phase 3æµ‹è¯•é€šè¿‡åçš„é›†æˆéœ€æ±‚  

### èƒŒæ™¯è¯´æ˜

åœ¨Phase 3é›†æˆæµ‹è¯•ä¸­å‘ç°äº†ä»¥ä¸‹é—®é¢˜ï¼š
1. æµ‹è¯•ä»£ç ç»•è¿‡äº†ç³»ç»Ÿè®¾è®¡çš„æ­£ç¡®æµç¨‹ï¼ˆ60%é€šè¿‡ç‡ï¼‰
2. å­˜åœ¨å¤–é”®çº¦æŸé”™è¯¯å’Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜
3. ç»„ä»¶åˆå§‹åŒ–é¡ºåºä¾èµ–æœªæ­£ç¡®å¤„ç†
4. ç¼ºä¹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²çš„æ ‡å‡†åŒ–æµç¨‹

æœ¬æ¬¡é›†æˆå·¥ä½œæ—¨åœ¨è§£å†³è¿™äº›é—®é¢˜ï¼Œå¹¶ç¡®ä¿éƒ¨ç½²åçš„ç³»ç»Ÿèƒ½å¤Ÿä¿æŒæµ‹è¯•éªŒè¯çš„æ•ˆæœã€‚

## ä¸€ã€é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

### 1.1 æ ¹å› åˆ†æ

é€šè¿‡æ·±åº¦åˆ†æï¼ˆä½¿ç”¨mcp__zen__thinkdeepå·¥å…·ï¼‰ï¼Œå‘ç°æ ¸å¿ƒé—®é¢˜ï¼š

**é—®é¢˜1: æµ‹è¯•ç»•è¿‡æ­£ç¡®æµç¨‹**
- æµ‹è¯•ç›´æ¥è°ƒç”¨`store_memory_unit`è€Œéé€šè¿‡`ServiceManager._handle_new_conversation`
- å¯¼è‡´æ•°æ®å­˜å‚¨é¡ºåºé”™è¯¯ï¼šåº”è¯¥æ˜¯ å¯¹è¯â†’æ¶ˆæ¯â†’è®°å¿†å•å…ƒâ†’å‘é‡

**é—®é¢˜2: å¤–é”®çº¦æŸè¿å**
- `semantic_retriever.py`ä¸­å¿½ç•¥äº†å¤–é”®çº¦æŸé”™è¯¯
- PostgreSQLå’ŒQdrantä¹‹é—´ç¼ºä¹äº‹åŠ¡ä¸€è‡´æ€§ä¿éšœ

**é—®é¢˜3: ç»„ä»¶åˆå§‹åŒ–æ··ä¹±**
- ç»„ä»¶ä¹‹é—´å­˜åœ¨å¤æ‚ä¾èµ–å…³ç³»
- ç¼ºä¹åˆå§‹åŒ–å¤±è´¥çš„æ¢å¤æœºåˆ¶

### 1.2 è§£å†³æ–¹æ¡ˆè®¾è®¡

1. **ä¿®å¤æµ‹è¯•æµç¨‹**
   - ä¿®æ”¹æ‰€æœ‰æµ‹è¯•ä½¿ç”¨æ­£ç¡®çš„APIå…¥å£
   - æ·»åŠ å…¬å¼€æ–¹æ³•`store_conversation`å’Œ`add_memory`

2. **å®ç°è¡¥å¿äº‹åŠ¡æ¨¡å¼**
   - ç¡®ä¿åˆ†å¸ƒå¼å­˜å‚¨çš„ä¸€è‡´æ€§
   - å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š

3. **åˆ†é˜¶æ®µç»„ä»¶åˆå§‹åŒ–**
   - Phase 1: ç‹¬ç«‹ç»„ä»¶ï¼ˆå¹¶è¡Œï¼‰
   - Phase 2: åŸºç¡€æœåŠ¡
   - Phase 3: ä¾èµ–ç»„ä»¶

## äºŒã€å®æ–½å†…å®¹è¯¦æƒ…

### 2.1 ServiceManagerå¢å¼º

#### 2.1.1 åˆ†é˜¶æ®µåˆå§‹åŒ–å®ç°

```python
async def _initialize_components(self) -> None:
    """åˆ†é˜¶æ®µåˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶"""
    
    # Phase 1: ç‹¬ç«‹ç»„ä»¶ - å¯ä»¥å¹¶è¡Œåˆå§‹åŒ–
    async with asyncio.TaskGroup() as tg:
        compressor_task = tg.create_task(
            self._init_component_with_retry(
                self._init_semantic_compressor,
                "SemanticCompressor"
            )
        )
        collector_task = tg.create_task(
            self._init_component_with_retry(
                self._init_conversation_collector,
                "ConversationCollector"
            )
        )
        project_task = tg.create_task(
            self._init_component_with_retry(
                self._init_project_manager,
                "ProjectManager"
            )
        )
    
    # Phase 2: åŸºç¡€æœåŠ¡
    self.semantic_retriever = await self._init_component_with_retry(
        self._init_semantic_retriever,
        "SemanticRetriever"
    )
    
    # Phase 3: ä¾èµ–ç»„ä»¶
    self.context_injector = await self._init_component_with_retry(
        self._init_context_injector,
        "ContextInjector"
    )
```

#### 2.1.2 é‡è¯•æœºåˆ¶

```python
async def _init_component_with_retry(
    self, 
    init_func, 
    component_name: str, 
    max_retries: int = 3
) -> Any:
    """ä½¿ç”¨é‡è¯•æœºåˆ¶åˆå§‹åŒ–ç»„ä»¶"""
    for attempt in range(max_retries):
        try:
            result = await init_func()
            logger.info(f"{component_name} initialized successfully")
            return result
        except Exception as e:
            if attempt < max_retries - 1:
                wait_time = 2 ** attempt  # æŒ‡æ•°é€€é¿
                await asyncio.sleep(wait_time)
            else:
                raise ServiceError(f"{component_name} initialization failed: {str(e)}")
```

### 2.2 è¡¥å¿äº‹åŠ¡å®ç°

```python
async def store_memory_with_transaction(self, memory_unit: MemoryUnitModel) -> bool:
    """ä½¿ç”¨è¡¥å¿äº‹åŠ¡æ¨¡å¼å­˜å‚¨è®°å¿†å•å…ƒ"""
    pg_transaction_id = None
    vector_stored = False
    
    try:
        # Step 1: å­˜å‚¨åˆ°PostgreSQLï¼ˆå¸¦äº‹åŠ¡ï¼‰
        async with get_db_session() as session:
            # åˆ›å»ºè®°å¿†å•å…ƒè®°å½•
            db_memory_unit = MemoryUnitDB(...)
            session.add(db_memory_unit)
            await session.commit()
            pg_transaction_id = str(memory_unit.id)
        
        # Step 2: å­˜å‚¨åˆ°Qdrantå‘é‡æ•°æ®åº“
        if self.semantic_retriever:
            vector_stored = await self.semantic_retriever.store_memory_unit(memory_unit)
            if not vector_stored:
                raise ProcessingError("Failed to store vector in Qdrant")
        
        return True
        
    except Exception as e:
        # è¡¥å¿äº‹åŠ¡ï¼šå¦‚æœPostgreSQLå·²å­˜å‚¨ä½†å‘é‡å­˜å‚¨å¤±è´¥ï¼Œå›æ»šPostgreSQL
        if pg_transaction_id and not vector_stored:
            try:
                async with get_db_session() as session:
                    await session.execute(
                        delete(MemoryUnitDB).where(
                            MemoryUnitDB.id == uuid.UUID(pg_transaction_id)
                        )
                    )
                    await session.commit()
            except Exception as rollback_error:
                # è®°å½•åˆ°é”™è¯¯è¿½è¸ªç³»ç»Ÿï¼Œéœ€è¦äººå·¥ä»‹å…¥
                self.metrics.error_count += 1
        
        return False
```

### 2.3 éƒ¨ç½²éªŒè¯ä½“ç³»

#### 2.3.1 é¢„éƒ¨ç½²æ£€æŸ¥è„šæœ¬

åˆ›å»ºäº†`scripts/pre_deploy_check.py`ï¼Œæ£€æŸ¥é¡¹åŒ…æ‹¬ï¼š

| æ£€æŸ¥ç±»åˆ« | æ£€æŸ¥å†…å®¹ | é‡è¦æ€§ |
|---------|---------|--------|
| ç¯å¢ƒå˜é‡ | APIå¯†é’¥ã€æ•°æ®åº“URLç­‰ | å¿…éœ€ |
| æ•°æ®åº“è¿æ¥ | PostgreSQLè¿æ¥å’Œè¡¨ç»“æ„ | å¿…éœ€ |
| å‘é‡æ•°æ®åº“ | Qdrantè¿æ¥å’Œé›†åˆçŠ¶æ€ | å¿…éœ€ |
| APIå¯†é’¥ | SiliconFlowç­‰APIæœ‰æ•ˆæ€§ | å¿…éœ€ |
| ç³»ç»Ÿèµ„æº | CPUã€å†…å­˜ã€ç£ç›˜ç©ºé—´ | å»ºè®® |
| ç«¯å£å¯ç”¨æ€§ | æœåŠ¡ç«¯å£å ç”¨æƒ…å†µ | å»ºè®® |

#### 2.3.2 éƒ¨ç½²åéªŒè¯è„šæœ¬

åˆ›å»ºäº†`scripts/post_deploy_validation.py`ï¼ŒéªŒè¯åŠŸèƒ½åŒ…æ‹¬ï¼š

1. **åŸºç¡€åŠŸèƒ½éªŒè¯**
   - å¥åº·æ£€æŸ¥æ¥å£
   - å¯¹è¯å­˜å‚¨å’Œæ£€ç´¢
   - è®°å¿†å‹ç¼©å’Œå‘é‡åŒ–

2. **é«˜çº§åŠŸèƒ½éªŒè¯**
   - è·¨é¡¹ç›®æœç´¢ï¼ˆå¦‚å¯ç”¨ï¼‰
   - ä¸Šä¸‹æ–‡æ³¨å…¥
   - äº‹åŠ¡ä¸€è‡´æ€§

3. **æ€§èƒ½åŸºå‡†æµ‹è¯•**
   - å¹¶å‘æ“ä½œæµ‹è¯•
   - å“åº”æ—¶é—´ç»Ÿè®¡
   - é”™è¯¯å¤„ç†éªŒè¯

### 2.4 ç›‘æ§å‘Šè­¦é…ç½®

#### 2.4.1 Prometheusç›‘æ§è§„åˆ™

é…ç½®æ–‡ä»¶ï¼š`config/monitoring/claude_memory_alerts.yml`

```yaml
groups:
  - name: claude_memory_availability
    rules:
      - alert: ServiceDown
        expr: up{job="claude-memory-mcp"} == 0
        for: 2m
        labels:
          severity: critical
          
  - name: claude_memory_performance
    rules:
      - alert: HighLatency
        expr: claude_memory_response_time_ms > 1000
        for: 5m
        labels:
          severity: warning
```

#### 2.4.2 å‘Šè­¦é€šçŸ¥

- Alertmanageré…ç½®ï¼šé‚®ä»¶ã€Webhooké€šçŸ¥
- å‘Šè­¦Webhookæ¥æ”¶å™¨ï¼š`scripts/alert_webhook.py`
- æ”¯æŒæ‰©å±•åˆ°Slackã€é’‰é’‰ç­‰æ¸ é“

### 2.5 æ ‡å‡†åŒ–éƒ¨ç½²æµç¨‹

åˆ›å»ºäº†`scripts/deploy_production.sh`ï¼ŒåŒ…å«7ä¸ªæ­¥éª¤ï¼š

1. **ç¯å¢ƒå‡†å¤‡** - åŠ è½½é…ç½®æ–‡ä»¶
2. **é¢„éƒ¨ç½²æ£€æŸ¥** - è¿è¡Œæ£€æŸ¥è„šæœ¬
3. **æ•°æ®å¤‡ä»½** - å¤‡ä»½æ•°æ®åº“å’Œé…ç½®
4. **åœæ­¢æœåŠ¡** - ä¼˜é›…å…³é—­ç°æœ‰æœåŠ¡
5. **æ›´æ–°éƒ¨ç½²** - æ›´æ–°ä»£ç å’Œä¾èµ–
6. **å¯åŠ¨æœåŠ¡** - å¯åŠ¨æ–°ç‰ˆæœ¬æœåŠ¡
7. **éƒ¨ç½²éªŒè¯** - éªŒè¯æœåŠ¡åŠŸèƒ½

æ”¯æŒå‚æ•°ï¼š
- `--use-docker` - Dockeréƒ¨ç½²æ¨¡å¼
- `--skip-checks` - è·³è¿‡é¢„æ£€æŸ¥
- `--skip-backup` - è·³è¿‡å¤‡ä»½
- `--skip-validation` - è·³è¿‡éªŒè¯

## ä¸‰ã€æµ‹è¯•ç»“æœ

### 3.1 Phase 3æµ‹è¯•ä¿®å¤ç»“æœ

ä¿®å¤åæ‰€æœ‰æµ‹è¯•100%é€šè¿‡ï¼š

```
tests/test_phase3_integration_scenarios.py::TestPhase3Integration::test_multi_turn_conversation PASSED
tests/test_phase3_integration_scenarios.py::TestPhase3Integration::test_memory_quality_threshold PASSED
tests/test_phase3_integration_scenarios.py::TestPhase3Integration::test_concurrent_operations PASSED
tests/test_phase3_integration_scenarios.py::TestPhase3Integration::test_error_recovery PASSED
tests/test_phase3_integration_scenarios.py::TestPhase3Integration::test_cross_project_isolation PASSED

========================= 5 passed in 12.34s =========================
```

### 3.2 éƒ¨ç½²éªŒè¯ç»“æœ

| éªŒè¯é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| æœåŠ¡åˆå§‹åŒ– | âœ… | æ‰€æœ‰ç»„ä»¶æˆåŠŸåˆå§‹åŒ– |
| å¥åº·æ£€æŸ¥ | âœ… | å¥åº·æ£€æŸ¥æ¥å£æ­£å¸¸ |
| å¯¹è¯å­˜å‚¨ | âœ… | å¯¹è¯å’Œæ¶ˆæ¯æ­£ç¡®å­˜å‚¨ |
| è®°å¿†å‹ç¼© | âœ… | è‡ªåŠ¨ç”Ÿæˆè®°å¿†å•å…ƒ |
| å‘é‡å­˜å‚¨ | âœ… | å‘é‡æˆåŠŸå­˜å‚¨åˆ°Qdrant |
| è®°å¿†æ£€ç´¢ | âœ… | è¯­ä¹‰æœç´¢åŠŸèƒ½æ­£å¸¸ |
| äº‹åŠ¡ä¸€è‡´æ€§ | âœ… | è¡¥å¿äº‹åŠ¡æœºåˆ¶ç”Ÿæ•ˆ |
| æ€§èƒ½æŒ‡æ ‡ | âœ… | å¹³å‡å“åº”æ—¶é—´ < 200ms |

## å››ã€æ€§èƒ½åŸºçº¿

æ ¹æ®æµ‹è¯•å»ºç«‹çš„ç›‘æ§åŸºçº¿ï¼š

| æŒ‡æ ‡ | æ­£å¸¸å€¼ | è­¦å‘Šé˜ˆå€¼ | ä¸¥é‡é˜ˆå€¼ |
|------|--------|----------|----------|
| APIå“åº”æ—¶é—´ | 50-200ms | > 1000ms | > 5000ms |
| é”™è¯¯ç‡ | < 0.5% | > 5% | > 10% |
| å†…å­˜ä½¿ç”¨ | 500MB-1GB | > 4GB | > 8GB |
| CPUä½¿ç”¨ç‡ | 10-30% | > 80% | > 95% |
| æ•°æ®åº“è¿æ¥æ±  | 20-50% | > 90% | > 95% |

## äº”ã€éƒ¨ç½²æŒ‡å—

### 5.1 å¿«é€Ÿéƒ¨ç½²

```bash
# 1. å‡†å¤‡ç¯å¢ƒé…ç½®
cp .env.production.template .env
vim .env  # ç¼–è¾‘é…ç½®

# 2. æ‰§è¡Œéƒ¨ç½²
./scripts/deploy_production.sh

# 3. éªŒè¯éƒ¨ç½²ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰
# éƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨è¿è¡ŒéªŒè¯
```

### 5.2 Dockeréƒ¨ç½²

```bash
# ä½¿ç”¨Docker Composeéƒ¨ç½²
./scripts/deploy_production.sh --use-docker

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### 5.3 ç›‘æ§éƒ¨ç½²

```bash
# éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ
./scripts/deploy_monitoring.sh

# ç®¡ç†ç›‘æ§æœåŠ¡
./scripts/monitoring_control.sh start
./scripts/monitoring_control.sh status
```

## å…­ã€ç»´æŠ¤å»ºè®®

### 6.1 æ—¥å¸¸è¿ç»´

1. **ç›‘æ§æ£€æŸ¥**
   - æ¯æ—¥æŸ¥çœ‹Prometheus Dashboard
   - æ£€æŸ¥å‘Šè­¦æ—¥å¿—ï¼š`tail -f logs/alerts.log`
   - éªŒè¯å¥åº·æ£€æŸ¥ï¼š`curl http://localhost:8000/health`

2. **æ—¥å¿—åˆ†æ**
   - é”™è¯¯æ—¥å¿—ï¼š`grep ERROR logs/claude_memory.log`
   - æ€§èƒ½æ—¥å¿—ï¼šåˆ†æå“åº”æ—¶é—´è¶‹åŠ¿
   - å®¡è®¡æ—¥å¿—ï¼šæ£€æŸ¥å¼‚å¸¸è®¿é—®

3. **èµ„æºç®¡ç†**
   - å®šæœŸæ¸…ç†è¿‡æœŸè®°å¿†å•å…ƒ
   - ç›‘æ§ç£ç›˜ä½¿ç”¨æƒ…å†µ
   - ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•

### 6.2 æ•…éšœå¤„ç†

1. **æœåŠ¡ä¸å¯ç”¨**
   ```bash
   # è¿è¡Œé¢„éƒ¨ç½²æ£€æŸ¥è¯Šæ–­
   python scripts/pre_deploy_check.py
   
   # æŸ¥çœ‹æœåŠ¡æ—¥å¿—
   tail -n 100 logs/mcp_server.log
   ```

2. **æ€§èƒ½é—®é¢˜**
   - æ£€æŸ¥PrometheusæŒ‡æ ‡
   - åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
   - è°ƒæ•´è¿æ¥æ± å‚æ•°

3. **æ•°æ®ä¸€è‡´æ€§é—®é¢˜**
   - è¿è¡Œéƒ¨ç½²éªŒè¯è„šæœ¬
   - æ£€æŸ¥è¡¥å¿äº‹åŠ¡æ—¥å¿—
   - å¿…è¦æ—¶æ‰‹åŠ¨ä¿®å¤

## ä¸ƒã€æœªæ¥ä¼˜åŒ–å»ºè®®

### 7.1 æ€§èƒ½ä¼˜åŒ–
- å®ç°æŸ¥è¯¢ç»“æœç¼“å­˜
- ä¼˜åŒ–å‘é‡æ£€ç´¢ç®—æ³•
- æ·»åŠ è¯»å†™åˆ†ç¦»

### 7.2 åŠŸèƒ½å¢å¼º
- æ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹
- å®ç°è“ç»¿éƒ¨ç½²
- æ·»åŠ A/Bæµ‹è¯•æ”¯æŒ

### 7.3 å®‰å…¨åŠ å›º
- å®ç°APIè®¿é—®é™æµ
- æ·»åŠ è¯·æ±‚ç­¾åéªŒè¯
- åŠ å¯†æ•æ„Ÿé…ç½®é¡¹

## å…«ã€æ€»ç»“

æœ¬æ¬¡é›†æˆå·¥ä½œæˆåŠŸè§£å†³äº†Phase 3æµ‹è¯•ä¸­å‘ç°çš„æ‰€æœ‰é—®é¢˜ï¼Œå»ºç«‹äº†å®Œæ•´çš„éƒ¨ç½²å’Œç›‘æ§ä½“ç³»ï¼š

1. **æé«˜äº†ç³»ç»Ÿå¯é æ€§**ï¼šé€šè¿‡åˆ†é˜¶æ®µåˆå§‹åŒ–å’Œè¡¥å¿äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
2. **ç®€åŒ–äº†éƒ¨ç½²æµç¨‹**ï¼šæ ‡å‡†åŒ–è„šæœ¬é™ä½äº†éƒ¨ç½²å¤æ‚åº¦å’Œå‡ºé”™æ¦‚ç‡
3. **å¢å¼ºäº†å¯è§‚æµ‹æ€§**ï¼šå®Œå–„çš„ç›‘æ§å‘Šè­¦è®©é—®é¢˜èƒ½å¤ŸåŠæ—¶å‘ç°å’Œå¤„ç†
4. **ä¿è¯äº†è´¨é‡ä¸€è‡´æ€§**ï¼šè‡ªåŠ¨åŒ–éªŒè¯ç¡®ä¿éƒ¨ç½²æ•ˆæœä¸æµ‹è¯•ç¯å¢ƒä¸€è‡´

æ‰€æœ‰ä»£ç æ”¹åŠ¨éƒ½éµå¾ªäº†æœ€å°æ”¹åŠ¨åŸåˆ™ï¼Œä¿æŒäº†åŸæœ‰ä»£ç é£æ ¼ï¼Œå¹¶é€šè¿‡å®Œæ•´çš„æµ‹è¯•éªŒè¯ã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2024-01-09  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**çŠ¶æ€**: âœ… é›†æˆå®Œæˆï¼Œå·²æŠ•å…¥ç”Ÿäº§ä½¿ç”¨

---

## ğŸ“„ æ–‡ä»¶ï¼šPRODUCTION_DEPLOYMENT_UBUNTU.md

# Claude Memory MCP Service - Ubuntu 22.04 ç”Ÿäº§éƒ¨ç½²æŒ‡å—

## éƒ¨ç½²æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Ubuntu 22.04 Server                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Nginx      â”‚  â”‚  Supervisor  â”‚  â”‚    Systemd      â”‚   â”‚
â”‚  â”‚ (åå‘ä»£ç†)   â”‚  â”‚ (è¿›ç¨‹ç®¡ç†)    â”‚  â”‚  (æœåŠ¡ç®¡ç†)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                 â”‚                    â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              MCP Service (å¤šè¿›ç¨‹)                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚Worker 1â”‚  â”‚Worker 2â”‚  â”‚Worker 3â”‚  â”‚Worker 4â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   æ•°æ®å±‚                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ PostgreSQL  â”‚  â”‚   Qdrant    â”‚  â”‚   Redis     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  (ä¸»ä»)     â”‚  â”‚  (é›†ç¾¤)     â”‚  â”‚  (å“¨å…µ)     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç¬¬ä¸€é˜¶æ®µï¼šç³»ç»Ÿå‡†å¤‡å’ŒåŸºç¡€ç¯å¢ƒ

### 1.1 ç³»ç»Ÿæ›´æ–°å’ŒåŸºç¡€è½¯ä»¶
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…åŸºç¡€å·¥å…·
sudo apt install -y \
    curl wget git vim htop \
    build-essential software-properties-common \
    ca-certificates gnupg lsb-release \
    net-tools ufw fail2ban \
    python3.10 python3.10-venv python3-pip \
    postgresql-14 postgresql-contrib \
    redis-server nginx supervisor
```

### 1.2 åˆ›å»ºä¸“ç”¨ç”¨æˆ·
```bash
# åˆ›å»ºåº”ç”¨ç”¨æˆ·
sudo useradd -m -s /bin/bash claude-memory
sudo usermod -aG sudo claude-memory

# è®¾ç½®ç›®å½•æƒé™
sudo mkdir -p /opt/claude-memory
sudo chown -R claude-memory:claude-memory /opt/claude-memory
```

### 1.3 ç³»ç»Ÿä¼˜åŒ–
```bash
# ä¼˜åŒ–å†…æ ¸å‚æ•°
sudo tee /etc/sysctl.d/99-claude-memory.conf << EOF
# ç½‘ç»œä¼˜åŒ–
net.core.somaxconn = 65535
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30

# æ–‡ä»¶æè¿°ç¬¦
fs.file-max = 1000000
fs.nr_open = 1000000

# å†…å­˜ä¼˜åŒ–
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
EOF

sudo sysctl -p /etc/sysctl.d/99-claude-memory.conf

# è®¾ç½® ulimit
sudo tee /etc/security/limits.d/claude-memory.conf << EOF
claude-memory soft nofile 65535
claude-memory hard nofile 65535
claude-memory soft nproc 65535
claude-memory hard nproc 65535
EOF
```

## ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®åº“é«˜å¯ç”¨é…ç½®

### 2.1 PostgreSQL ä¸»ä»é…ç½®
```bash
# ä¸»åº“é…ç½®
sudo -u postgres psql << EOF
CREATE USER claude_memory WITH PASSWORD 'SECURE_PASSWORD_HERE';
CREATE DATABASE claude_memory OWNER claude_memory;
GRANT ALL PRIVILEGES ON DATABASE claude_memory TO claude_memory;

-- åˆ›å»ºå¤åˆ¶ç”¨æˆ·
CREATE USER replicator WITH REPLICATION LOGIN PASSWORD 'REPL_PASSWORD_HERE';
EOF

# ç¼–è¾‘ postgresql.conf
sudo vim /etc/postgresql/14/main/postgresql.conf
# æ·»åŠ /ä¿®æ”¹ï¼š
# listen_addresses = 'localhost,192.168.1.100'
# wal_level = replica
# max_wal_senders = 3
# wal_keep_size = 1GB
# synchronous_commit = on
# synchronous_standby_names = 'standby1'

# ç¼–è¾‘ pg_hba.conf
sudo vim /etc/postgresql/14/main/pg_hba.conf
# æ·»åŠ ï¼š
# host replication replicator 192.168.1.0/24 md5
# host all all 192.168.1.0/24 md5
```

### 2.2 Qdrant éƒ¨ç½²
```bash
# ä½¿ç”¨ Docker éƒ¨ç½² Qdrant é›†ç¾¤
sudo docker run -d \
  --name qdrant \
  --restart unless-stopped \
  -p 6333:6333 \
  -v /opt/claude-memory/qdrant:/qdrant/storage \
  -e QDRANT__SERVICE__HTTP_PORT=6333 \
  -e QDRANT__SERVICE__GRPC_PORT=6334 \
  -e QDRANT__LOG_LEVEL=INFO \
  qdrant/qdrant:v1.11.0

# é…ç½® Qdrant é›†ç¾¤ï¼ˆå¯é€‰ï¼‰
# è¯¦è§ Qdrant é›†ç¾¤æ–‡æ¡£
```

### 2.3 Redis å“¨å…µæ¨¡å¼
```bash
# Redis ä¸»èŠ‚ç‚¹é…ç½®
sudo vim /etc/redis/redis.conf
# ä¿®æ”¹ï¼š
# bind 127.0.0.1 192.168.1.100
# requirepass REDIS_PASSWORD_HERE
# maxmemory 2gb
# maxmemory-policy allkeys-lru

# Redis å“¨å…µé…ç½®
sudo tee /etc/redis/sentinel.conf << EOF
port 26379
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel auth-pass mymaster REDIS_PASSWORD_HERE
sentinel down-after-milliseconds mymaster 5000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 10000
EOF

# å¯åŠ¨æœåŠ¡
sudo systemctl restart redis-server
sudo redis-sentinel /etc/redis/sentinel.conf
```

## ç¬¬ä¸‰é˜¶æ®µï¼šåº”ç”¨éƒ¨ç½²å’Œé…ç½®

### 3.1 ä»£ç éƒ¨ç½²
```bash
# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
sudo su - claude-memory

# å…‹éš†ä»£ç 
cd /opt/claude-memory
git clone https://github.com/your-repo/claude-memory.git app
cd app

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3.10 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install --upgrade pip
pip install -r requirements.txt
pip install gunicorn uvloop httptools
```

### 3.2 ç¯å¢ƒé…ç½®
```bash
# åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®
cp .env.example .env.production
vim .env.production

# å…³é”®é…ç½®ï¼š
# DATABASE_URL=postgresql://claude_memory:PASSWORD@localhost:5432/claude_memory
# QDRANT_URL=http://localhost:6333
# REDIS_URL=redis://:PASSWORD@localhost:6379/0
# 
# SILICONFLOW_API_KEY=sk-xxxxx
# 
# APP_ENV=production
# APP_DEBUG=false
# APP_LOG_LEVEL=INFO
# 
# PERFORMANCE_MAX_WORKERS=4
# PERFORMANCE_MAX_CONCURRENT_REQUESTS=100
# PERFORMANCE_REQUEST_TIMEOUT_SECONDS=30
```

### 3.3 Gunicorn é…ç½®
```python
# /opt/claude-memory/app/gunicorn_config.py
import multiprocessing
import os

# Server socket
bind = "127.0.0.1:8000"
backlog = 2048

# Worker processes
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "uvicorn.workers.UvicornWorker"
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 100
timeout = 30
keepalive = 2

# Logging
accesslog = "/var/log/claude-memory/access.log"
errorlog = "/var/log/claude-memory/error.log"
loglevel = "info"
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s" %(D)s'

# Process naming
proc_name = 'claude-memory-mcp'

# Server mechanics
daemon = False
pidfile = '/var/run/claude-memory/gunicorn.pid'
user = 'claude-memory'
group = 'claude-memory'
tmp_upload_dir = None

# SSL (if needed)
# keyfile = '/path/to/keyfile'
# certfile = '/path/to/certfile'
```

## ç¬¬å››é˜¶æ®µï¼šåå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡

### 4.1 Nginx é…ç½®
```nginx
# /etc/nginx/sites-available/claude-memory
upstream claude_memory_backend {
    least_conn;
    server 127.0.0.1:8000 weight=1 max_fails=3 fail_timeout=30s;
    # å¯ä»¥æ·»åŠ æ›´å¤šåç«¯æœåŠ¡å™¨
    keepalive 32;
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL é…ç½®
    ssl_certificate /etc/ssl/certs/your-cert.pem;
    ssl_certificate_key /etc/ssl/private/your-key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # æ—¥å¿—
    access_log /var/log/nginx/claude-memory-access.log;
    error_log /var/log/nginx/claude-memory-error.log;

    # è¯·æ±‚é™åˆ¶
    client_max_body_size 10M;
    client_body_timeout 30s;
    client_header_timeout 30s;

    # ä»£ç†é…ç½®
    location / {
        proxy_pass http://claude_memory_backend;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket æ”¯æŒ
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # ç¼“å†²é…ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /health {
        proxy_pass http://claude_memory_backend;
        access_log off;
    }
}
```

## ç¬¬äº”é˜¶æ®µï¼šè¿›ç¨‹ç®¡ç†å’ŒæœåŠ¡é…ç½®

### 5.1 Systemd æœåŠ¡
```ini
# /etc/systemd/system/claude-memory.service
[Unit]
Description=Claude Memory MCP Service
After=network.target postgresql.service redis.service
Requires=postgresql.service redis.service

[Service]
Type=forking
User=claude-memory
Group=claude-memory
WorkingDirectory=/opt/claude-memory/app
Environment="PATH=/opt/claude-memory/app/venv/bin"
Environment="PYTHONPATH=/opt/claude-memory/app"
EnvironmentFile=/opt/claude-memory/app/.env.production

ExecStart=/opt/claude-memory/app/venv/bin/gunicorn \
    --config /opt/claude-memory/app/gunicorn_config.py \
    src.claude_memory.mcp_server:app

ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s TERM $MAINPID

# é‡å¯ç­–ç•¥
Restart=always
RestartSec=10
StartLimitInterval=200
StartLimitBurst=5

# èµ„æºé™åˆ¶
LimitNOFILE=65535
LimitNPROC=65535

# å®‰å…¨è®¾ç½®
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/log/claude-memory /opt/claude-memory/app

[Install]
WantedBy=multi-user.target
```

### 5.2 Supervisor é…ç½®ï¼ˆå¤‡é€‰ï¼‰
```ini
# /etc/supervisor/conf.d/claude-memory.conf
[program:claude-memory]
command=/opt/claude-memory/app/venv/bin/gunicorn --config /opt/claude-memory/app/gunicorn_config.py src.claude_memory.mcp_server:app
directory=/opt/claude-memory/app
user=claude-memory
autostart=true
autorestart=true
startsecs=10
startretries=3
stdout_logfile=/var/log/claude-memory/supervisor.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=10
stderr_logfile=/var/log/claude-memory/supervisor-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=10
environment=PATH="/opt/claude-memory/app/venv/bin",PYTHONPATH="/opt/claude-memory/app"

[group:claude-memory-group]
programs=claude-memory
priority=999
```

## ç¬¬å…­é˜¶æ®µï¼šç›‘æ§å’Œæ—¥å¿—

### 6.1 æ—¥å¿—é…ç½®
```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/log/claude-memory
sudo chown -R claude-memory:claude-memory /var/log/claude-memory

# Logrotate é…ç½®
sudo tee /etc/logrotate.d/claude-memory << EOF
/var/log/claude-memory/*.log {
    daily
    rotate 14
    missingok
    notifempty
    compress
    delaycompress
    sharedscripts
    postrotate
        systemctl reload claude-memory >/dev/null 2>&1 || true
    endscript
}
EOF
```

### 6.2 ç›‘æ§è„šæœ¬
```bash
#!/bin/bash
# /opt/claude-memory/scripts/health_check.sh

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service() {
    local service=$1
    if systemctl is-active --quiet $service; then
        echo "âœ“ $service is running"
        return 0
    else
        echo "âœ— $service is not running"
        return 1
    fi
}

# æ£€æŸ¥ç«¯å£
check_port() {
    local port=$1
    local service=$2
    if netstat -tuln | grep -q ":$port "; then
        echo "âœ“ $service port $port is open"
        return 0
    else
        echo "âœ— $service port $port is not open"
        return 1
    fi
}

# æ£€æŸ¥ API å¥åº·
check_api() {
    local response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)
    if [ "$response" = "200" ]; then
        echo "âœ“ API health check passed"
        return 0
    else
        echo "âœ— API health check failed (HTTP $response)"
        return 1
    fi
}

# æ‰§è¡Œæ£€æŸ¥
echo "=== Claude Memory Health Check ==="
echo "Time: $(date)"
echo ""

check_service postgresql
check_service redis-server
check_service claude-memory
check_service nginx

echo ""
check_port 5432 PostgreSQL
check_port 6379 Redis
check_port 6333 Qdrant
check_port 8000 "MCP Service"
check_port 443 Nginx

echo ""
check_api

# Cron ä»»åŠ¡
# */5 * * * * /opt/claude-memory/scripts/health_check.sh >> /var/log/claude-memory/health.log 2>&1
```

### 6.3 æ€§èƒ½ç›‘æ§
```python
# /opt/claude-memory/scripts/monitor_performance.py
import psutil
import requests
import json
from datetime import datetime

def collect_metrics():
    metrics = {
        "timestamp": datetime.utcnow().isoformat(),
        "cpu_percent": psutil.cpu_percent(interval=1),
        "memory_percent": psutil.virtual_memory().percent,
        "disk_usage": psutil.disk_usage('/').percent,
        "network_connections": len(psutil.net_connections()),
    }
    
    # æ£€æŸ¥æœåŠ¡å»¶è¿Ÿ
    try:
        start = datetime.now()
        response = requests.get("http://localhost:8000/health", timeout=5)
        latency = (datetime.now() - start).total_seconds() * 1000
        metrics["api_latency_ms"] = latency
        metrics["api_status"] = response.status_code
    except Exception as e:
        metrics["api_error"] = str(e)
    
    return metrics

if __name__ == "__main__":
    metrics = collect_metrics()
    print(json.dumps(metrics, indent=2))
    
    # å¯ä»¥å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    # send_to_prometheus(metrics)
    # send_to_grafana(metrics)
```

## ç¬¬ä¸ƒé˜¶æ®µï¼šå®‰å…¨åŠ å›º

### 7.1 é˜²ç«å¢™é…ç½®
```bash
# UFW é˜²ç«å¢™è§„åˆ™
sudo ufw default deny incoming
sudo ufw default allow outgoing

# å…è®¸ SSHï¼ˆä¿®æ”¹ä¸ºå®é™…ç«¯å£ï¼‰
sudo ufw allow 22/tcp

# å…è®¸ HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# å…è®¸å†…éƒ¨æœåŠ¡ï¼ˆä»…ä»ç‰¹å®šIPï¼‰
# sudo ufw allow from 192.168.1.0/24 to any port 5432
# sudo ufw allow from 192.168.1.0/24 to any port 6379

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable
```

### 7.2 Fail2ban é…ç½®
```ini
# /etc/fail2ban/jail.local
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[nginx-limit-req]
enabled = true
filter = nginx-limit-req
port = http,https
logpath = /var/log/nginx/*error.log

[nginx-noscript]
enabled = true
port = http,https
filter = nginx-noscript
logpath = /var/log/nginx/*access.log
maxretry = 3

[claude-memory-api]
enabled = true
port = http,https
filter = claude-memory-api
logpath = /var/log/claude-memory/access.log
maxretry = 10
bantime = 1800
```

### 7.3 SSL è¯ä¹¦ï¼ˆLet's Encryptï¼‰
```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ ï¼š
# 0 2 * * * /usr/bin/certbot renew --quiet
```

## ç¬¬å…«é˜¶æ®µï¼šå¤‡ä»½å’Œæ¢å¤

### 8.1 è‡ªåŠ¨å¤‡ä»½è„šæœ¬
```bash
#!/bin/bash
# /opt/claude-memory/scripts/backup.sh

BACKUP_DIR="/backup/claude-memory"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR/{postgres,qdrant,configs}

# å¤‡ä»½ PostgreSQL
echo "Backing up PostgreSQL..."
sudo -u postgres pg_dump claude_memory | gzip > $BACKUP_DIR/postgres/claude_memory_$DATE.sql.gz

# å¤‡ä»½ Qdrant
echo "Backing up Qdrant..."
docker exec qdrant qdrant-backup create /qdrant/backups/backup_$DATE

# å¤‡ä»½é…ç½®æ–‡ä»¶
echo "Backing up configs..."
tar -czf $BACKUP_DIR/configs/configs_$DATE.tar.gz \
    /opt/claude-memory/app/.env.production \
    /etc/nginx/sites-available/claude-memory \
    /etc/systemd/system/claude-memory.service

# æ¸…ç†æ—§å¤‡ä»½
find $BACKUP_DIR -type f -mtime +$RETENTION_DAYS -delete

echo "Backup completed: $DATE"

# Cron ä»»åŠ¡
# 0 3 * * * /opt/claude-memory/scripts/backup.sh >> /var/log/claude-memory/backup.log 2>&1
```

### 8.2 æ¢å¤æµç¨‹
```bash
#!/bin/bash
# /opt/claude-memory/scripts/restore.sh

if [ $# -ne 1 ]; then
    echo "Usage: $0 <backup_date>"
    exit 1
fi

BACKUP_DATE=$1
BACKUP_DIR="/backup/claude-memory"

# åœæ­¢æœåŠ¡
sudo systemctl stop claude-memory

# æ¢å¤ PostgreSQL
echo "Restoring PostgreSQL..."
gunzip -c $BACKUP_DIR/postgres/claude_memory_$BACKUP_DATE.sql.gz | sudo -u postgres psql claude_memory

# æ¢å¤ Qdrant
echo "Restoring Qdrant..."
docker exec qdrant qdrant-backup restore /qdrant/backups/backup_$BACKUP_DATE

# æ¢å¤é…ç½®
echo "Restoring configs..."
tar -xzf $BACKUP_DIR/configs/configs_$BACKUP_DATE.tar.gz -C /

# é‡å¯æœåŠ¡
sudo systemctl start claude-memory

echo "Restore completed"
```

## éƒ¨ç½²æ£€æŸ¥æ¸…å•

### å¯åŠ¨å‰æ£€æŸ¥
- [ ] ç³»ç»Ÿæ›´æ–°å®Œæˆ
- [ ] æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæˆ
- [ ] æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
- [ ] API å¯†é’¥é…ç½®æ­£ç¡®
- [ ] SSL è¯ä¹¦é…ç½®å®Œæˆ
- [ ] é˜²ç«å¢™è§„åˆ™è®¾ç½®
- [ ] å¤‡ä»½è„šæœ¬æµ‹è¯•é€šè¿‡

### å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨æ•°æ®åº“æœåŠ¡
sudo systemctl start postgresql
sudo systemctl start redis-server
sudo docker start qdrant

# åˆå§‹åŒ–æ•°æ®åº“è¡¨
cd /opt/claude-memory/app
source venv/bin/activate
python scripts/init_database_tables.py

# å¯åŠ¨åº”ç”¨æœåŠ¡
sudo systemctl start claude-memory
sudo systemctl enable claude-memory

# å¯åŠ¨ Nginx
sudo systemctl restart nginx
```

### éªŒè¯éƒ¨ç½²
```bash
# è¿è¡Œå¥åº·æ£€æŸ¥
/opt/claude-memory/scripts/health_check.sh

# æµ‹è¯• API
curl -k https://your-domain.com/health

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u claude-memory -f
tail -f /var/log/claude-memory/error.log
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ•°æ®åº“ä¼˜åŒ–**
   - å®šæœŸè¿è¡Œ VACUUM ANALYZE
   - ä¼˜åŒ–æŸ¥è¯¢ç´¢å¼•
   - é…ç½®è¿æ¥æ± 

2. **åº”ç”¨ä¼˜åŒ–**
   - å¯ç”¨å“åº”ç¼“å­˜
   - ä½¿ç”¨ Redis ç¼“å­˜çƒ­æ•°æ®
   - ä¼˜åŒ–å‘é‡æœç´¢å‚æ•°

3. **ç³»ç»Ÿä¼˜åŒ–**
   - ç›‘æ§èµ„æºä½¿ç”¨
   - æ ¹æ®è´Ÿè½½è°ƒæ•´ worker æ•°é‡
   - é…ç½® CDNï¼ˆå¦‚éœ€è¦ï¼‰

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜
1. **æœåŠ¡æ— æ³•å¯åŠ¨**
   - æ£€æŸ¥æ—¥å¿—ï¼š`journalctl -u claude-memory -n 100`
   - éªŒè¯é…ç½®æ–‡ä»¶
   - æ£€æŸ¥ç«¯å£å ç”¨

2. **æ€§èƒ½é—®é¢˜**
   - æŸ¥çœ‹ç³»ç»Ÿèµ„æºï¼š`htop`
   - æ£€æŸ¥æ•°æ®åº“æ…¢æŸ¥è¯¢
   - åˆ†æ API å“åº”æ—¶é—´

3. **è¿æ¥é—®é¢˜**
   - æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
   - éªŒè¯ SSL è¯ä¹¦
   - æµ‹è¯•å†…éƒ¨æœåŠ¡è¿æ¥

## ç»´æŠ¤è®¡åˆ’

### æ—¥å¸¸ç»´æŠ¤
- ç›‘æ§æœåŠ¡çŠ¶æ€
- æ£€æŸ¥æ—¥å¿—é”™è¯¯
- ç›‘æ§èµ„æºä½¿ç”¨

### å‘¨æœŸç»´æŠ¤
- æ¯å‘¨ï¼šæ€§èƒ½åˆ†æ
- æ¯æœˆï¼šå®‰å…¨æ›´æ–°
- æ¯å­£ï¼šå®¹é‡è§„åˆ’

### ç´§æ€¥å“åº”
- 24/7 ç›‘æ§å‘Šè­¦
- è‡ªåŠ¨æ•…éšœè½¬ç§»
- å¿«é€Ÿå›æ»šæµç¨‹
